using QuestionarioOnline.Domain.Exceptions;
using QuestionarioOnline.Domain.ValueObjects;

namespace QuestionarioOnline.Domain.Entities;

public class Resposta
{
    public Guid Id { get; private set; }
    public Guid QuestionarioId { get; private set; }
    public OrigemResposta OrigemResposta { get; private set; } = null!;
    public DateTime DataResposta { get; private set; }

    public string? Estado { get; private set; }
    public string? Cidade { get; private set; }
    public string? RegiaoGeografica { get; private set; }
    public string? DispositivoTipo { get; private set; }
    public string? NavegadorTipo { get; private set; }

    private readonly List<RespostaItem> _itens = new();
    public IReadOnlyCollection<RespostaItem> Itens => _itens.AsReadOnly();

    private Resposta() { }

    public static Resposta Criar(
        Guid questionarioId,
        string ipAddress,
        string userAgent,
        string? estado = null,
        string? cidade = null,
        string? regiaoGeografica = null,
        string? dispositivoTipo = null,
        string? navegadorTipo = null)
    {
        if (questionarioId == Guid.Empty)
            throw new ArgumentException("Questionário inválido", nameof(questionarioId));

        var origemResposta = OrigemResposta.Create(ipAddress, userAgent);

        return new Resposta
        {
            Id = Guid.NewGuid(),
            QuestionarioId = questionarioId,
            OrigemResposta = origemResposta,
            DataResposta = DateTime.UtcNow,
            Estado = estado,
            Cidade = cidade,
            RegiaoGeografica = regiaoGeografica,
            DispositivoTipo = dispositivoTipo,
            NavegadorTipo = navegadorTipo
        };
    }

    public void AdicionarItem(RespostaItem item)
    {
        ArgumentNullException.ThrowIfNull(item, nameof(item));

        if (_itens.Any(i => i.PerguntaId == item.PerguntaId))
            throw new DomainException("Já existe uma resposta para esta pergunta");

        _itens.Add(item);
    }

    public void GarantirCompletude(IEnumerable<Pergunta> perguntas)
    {
        var perguntasObrigatorias = perguntas.Where(p => p.Obrigatoria).ToList();
        var perguntasRespondidas = _itens.Select(i => i.PerguntaId).ToList();

        foreach (var pergunta in perguntasObrigatorias)
        {
            if (!perguntasRespondidas.Contains(pergunta.Id))
                throw new DomainException($"A pergunta '{pergunta.Texto}' é obrigatória e não foi respondida");
        }
    }
}
