using QuestionarioOnline.Domain.Enums;
using QuestionarioOnline.Domain.Exceptions;
using QuestionarioOnline.Domain.ValueObjects;

namespace QuestionarioOnline.Domain.Entities;

public class Questionario
{
    public Guid Id { get; private set; }
    public string Titulo { get; private set; } = string.Empty;
    public string? Descricao { get; private set; }
    public StatusQuestionario Status { get; private set; }
    public PeriodoColeta PeriodoColeta { get; private set; } = null!;
    public Guid UsuarioId { get; private set; }
    public DateTime DataCriacao { get; private set; }
    public DateTime? DataEncerramento { get; private set; }

    private readonly List<Pergunta> _perguntas = new();
    public IReadOnlyCollection<Pergunta> Perguntas => _perguntas.AsReadOnly();

    private Questionario() { }

    public static Questionario Criar(
        string titulo,
        string? descricao,
        DateTime dataInicio,
        DateTime dataFim,
        Guid usuarioId)
    {
        ArgumentException.ThrowIfNullOrWhiteSpace(titulo, nameof(titulo));

        if (usuarioId == Guid.Empty)
            throw new ArgumentException("Usuário inválido", nameof(usuarioId));

        var periodoColeta = PeriodoColeta.Create(dataInicio, dataFim);

        return new Questionario
        {
            Id = Guid.NewGuid(),
            Titulo = titulo,
            Descricao = descricao,
            Status = StatusQuestionario.Ativo,
            PeriodoColeta = periodoColeta,
            UsuarioId = usuarioId,
            DataCriacao = DateTime.UtcNow
        };
    }

    public void AdicionarPergunta(Pergunta pergunta)
    {
        GarantirQueNaoEstaEncerrado();
        ArgumentNullException.ThrowIfNull(pergunta, nameof(pergunta));

        _perguntas.Add(pergunta);
    }

    public void AdicionarPergunta(string texto, int ordem, bool obrigatoria, IEnumerable<(string Texto, int Ordem)> opcoes)
    {
        GarantirQueNaoEstaEncerrado();

        var pergunta = new Pergunta(Id, texto, ordem, obrigatoria);
        pergunta.AdicionarOpcoes(opcoes);

        _perguntas.Add(pergunta);
    }

    public void RemoverPergunta(Guid perguntaId)
    {
        GarantirQueNaoEstaEncerrado();

        var pergunta = _perguntas.FirstOrDefault(p => p.Id == perguntaId);
        if (pergunta is not null)
            _perguntas.Remove(pergunta);
    }

    public void Encerrar()
    {
        if (Status == StatusQuestionario.Encerrado)
            throw new QuestionarioJaEncerradoException();

        Status = StatusQuestionario.Encerrado;
        DataEncerramento = DateTime.UtcNow;
    }

    public void GarantirQuePodeReceberRespostas()
    {
        if (Status != StatusQuestionario.Ativo)
            throw new QuestionarioNaoPodeReceberRespostasException("Questionário não está ativo");

        if (!PeriodoColeta.EstaAtivo())
            throw new QuestionarioNaoPodeReceberRespostasException("Período de coleta encerrado");
    }

    private void GarantirQueNaoEstaEncerrado()
    {
        if (Status == StatusQuestionario.Encerrado)
            throw new QuestionarioJaEncerradoException();
    }
}
