using Microsoft.AspNetCore.Mvc;
using QuestionarioOnline.Api.Requests;
using QuestionarioOnline.Api.Responses;
using QuestionarioOnline.Api.Validators;
using QuestionarioOnline.Application.DTOs.Requests;
using QuestionarioOnline.Application.DTOs.Responses;
using QuestionarioOnline.Application.Interfaces;

namespace QuestionarioOnline.Api.Controllers;

[Route("api/[controller]")]
public class RespostaController : BaseController
{
    private readonly IRespostaService _respostaService;
    private readonly RegistrarRespostaApiRequestValidator _validator;

    public RespostaController(
        IRespostaService respostaService,
        RegistrarRespostaApiRequestValidator validator)
    {
        _respostaService = respostaService;
        _validator = validator;
    }

    [HttpPost]
    [ProducesResponseType(typeof(ApiResponse<RespostaRegistradaDto>), StatusCodes.Status202Accepted)]
    [ProducesResponseType(typeof(ApiResponse<RespostaRegistradaDto>), StatusCodes.Status400BadRequest)]
    public async Task<ActionResult<ApiResponse<RespostaRegistradaDto>>> Registrar(
        [FromBody] RegistrarRespostaApiRequest request,
        CancellationToken cancellationToken)
    {
        var validationResult = await _validator.ValidateAsync(request, cancellationToken);

        if (!validationResult.IsValid)
            return ValidationErrorResponse<RespostaRegistradaDto>(validationResult);

        var applicationRequest = MapearParaApplicationRequest(request);

        var result = await _respostaService.RegistrarRespostaAsync(applicationRequest, cancellationToken);

        if (result.IsFailure)
            return FailResponse(result);

        return AcceptedResponse(result.Value, "Resposta recebida e será processada em breve");
    }

    private static RegistrarRespostaRequest MapearParaApplicationRequest(RegistrarRespostaApiRequest apiRequest)
    {
        var respostas = apiRequest.Respostas
            .Select(r => new RespostaItemDto(r.PerguntaId, r.OpcaoRespostaId))
            .ToList();

        return new RegistrarRespostaRequest(
            apiRequest.QuestionarioId,
            respostas,
            apiRequest.Estado,
            apiRequest.Cidade,
            apiRequest.RegiaoGeografica
        );
    }
}
