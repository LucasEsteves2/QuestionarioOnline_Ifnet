using QuestionarioOnline.Application.DTOs.Requests;
using QuestionarioOnline.Application.DTOs.Responses;
using QuestionarioOnline.Application.Interfaces;
using QuestionarioOnline.Application.Validators;
using QuestionarioOnline.Domain.Entities;
using QuestionarioOnline.Domain.Exceptions;
using QuestionarioOnline.Domain.Interfaces;
using QuestionarioOnline.Domain.ValueObjects;

namespace QuestionarioOnline.Application.Services;

public class QuestionarioService : IQuestionarioService
{
    private readonly IQuestionarioRepository _questionarioRepository;
    private readonly IRespostaRepository _respostaRepository;
    private readonly CriarQuestionarioRequestValidator _validator;

    public QuestionarioService(
        IQuestionarioRepository questionarioRepository, 
        IRespostaRepository respostaRepository,
        CriarQuestionarioRequestValidator validator)
    {
        _questionarioRepository = questionarioRepository;
        _respostaRepository = respostaRepository;
        _validator = validator;
    }

    public async Task<Result<QuestionarioDto>> CriarQuestionarioAsync(
        CriarQuestionarioRequest request, 
        Guid usuarioId, 
        CancellationToken cancellationToken = default)
    {
        var validationResult = await _validator.ValidateAsync(request, cancellationToken);
        
        if (!validationResult.IsValid)
            return ValidationFailure<QuestionarioDto>(validationResult);

        try
        {
            var questionario = CriarQuestionarioComPerguntas(request, usuarioId);
            await _questionarioRepository.AdicionarAsync(questionario, cancellationToken);
            return Result.Success(MapearParaDto(questionario));
        }
        catch (DomainException ex)
        {
            return Result.Failure<QuestionarioDto>(ex.Message);
        }
    }

    public async Task<Result<QuestionarioDto>> EncerrarQuestionarioAsync(
        Guid questionarioId,
        Guid usuarioId,
        CancellationToken cancellationToken = default)
    {
        var questionario = await _questionarioRepository.ObterPorIdComPerguntasAsync(questionarioId, cancellationToken);

        if (questionario is null)
            return Result.Failure<QuestionarioDto>("Questionário não encontrado");

        if (!UsuarioTemPermissao(questionario, usuarioId))
            return Result.Failure<QuestionarioDto>("Usuário não autorizado");

        try
        {
            questionario.Encerrar();
            await _questionarioRepository.AtualizarAsync(questionario, cancellationToken);
            return Result.Success(MapearParaDto(questionario));
        }
        catch (DomainException ex)
        {
            return Result.Failure<QuestionarioDto>(ex.Message);
        }
    }

    public async Task<Result> DeletarQuestionarioAsync(
        Guid questionarioId,
        Guid usuarioId,
        CancellationToken cancellationToken = default)
    {
        var questionario = await _questionarioRepository.ObterPorIdComPerguntasAsync(questionarioId, cancellationToken);

        if (questionario is null)
            return Result.Failure("Questionário não encontrado");

        if (!UsuarioTemPermissao(questionario, usuarioId))
            return Result.Failure("Usuário não autorizado");

        if (await QuestionarioTemRespostas(questionarioId, cancellationToken))
            return Result.Failure("Não é possível deletar questionário que já possui respostas");

        await _questionarioRepository.DeletarAsync(questionario, cancellationToken);
        return Result.Success();
    }

    public async Task<QuestionarioPublicoDto?> ObterQuestionarioPublicoAsync(
        Guid questionarioId,
        CancellationToken cancellationToken = default)
    {
        var questionario = await _questionarioRepository.ObterPorIdComPerguntasAsync(questionarioId, cancellationToken);

        if (questionario is null)
            return null;

        try
        {
            questionario.GarantirQuePodeReceberRespostas();
            return MapearParaPublicoDto(questionario);
        }
        catch (DomainException)
        {
            return null;
        }
    }

    public async Task<QuestionarioDto?> ObterQuestionarioPorIdAsync(
        Guid questionarioId,
        Guid usuarioId,
        CancellationToken cancellationToken = default)
    {
        var questionario = await _questionarioRepository.ObterPorIdComPerguntasAsync(questionarioId, cancellationToken);

        if (questionario is null || !UsuarioTemPermissao(questionario, usuarioId))
            return null;

        return MapearParaDto(questionario);
    }

    public async Task<IEnumerable<QuestionarioListaDto>> ListarQuestionariosPorUsuarioAsync(
        Guid usuarioId,
        CancellationToken cancellationToken = default)
    {
        var questionarios = await _questionarioRepository.ObterTodosPorUsuarioAsync(usuarioId, cancellationToken);
        return questionarios.Select(MapearParaListaDto);
    }

    public async Task<Result<ResultadoQuestionarioDto>> ObterResultadosAsync(
        Guid questionarioId,
        Guid usuarioId,
        CancellationToken cancellationToken = default)
    {
        var questionario = await _questionarioRepository.ObterPorIdComPerguntasAsync(questionarioId, cancellationToken);

        if (questionario is null)
            return Result.Failure<ResultadoQuestionarioDto>("Questionário não encontrado");

        if (!UsuarioTemPermissao(questionario, usuarioId))
            return Result.Failure<ResultadoQuestionarioDto>("Usuário não autorizado");

        var respostas = await _respostaRepository.ObterPorQuestionarioAsync(questionarioId, cancellationToken);
        var resultado = CalcularResultados(questionario, respostas);

        return Result.Success(resultado);
    }

    private static Questionario CriarQuestionarioComPerguntas(CriarQuestionarioRequest request, Guid usuarioId)
    {
        var questionario = Questionario.Criar(request.Titulo, request.Descricao, request.DataInicio, request.DataFim, usuarioId);
        
        foreach (var p in request.Perguntas.OrderBy(x => x.Ordem))
            questionario.AdicionarPergunta(p.Texto, p.Ordem, p.Obrigatoria, p.Opcoes.Select(o => (o.Texto, o.Ordem)));

        return questionario;
    }

    private static bool UsuarioTemPermissao(Questionario questionario, Guid usuarioId) 
        => questionario.UsuarioId == usuarioId;

    private async Task<bool> QuestionarioTemRespostas(Guid questionarioId, CancellationToken ct) 
        => await _respostaRepository.ContarRespostasPorQuestionarioAsync(questionarioId, ct) > 0;

    private ResultadoQuestionarioDto CalcularResultados(Questionario questionario, IEnumerable<Resposta> respostas)
    {
        var total = respostas.Count();
        var resultados = questionario.Perguntas.Select(p => CalcularResultadoPergunta(p, respostas, total)).ToList();
        return new ResultadoQuestionarioDto(questionario.Id, questionario.Titulo, total, resultados);
    }

    private static ResultadoPerguntaDto CalcularResultadoPergunta(Pergunta p, IEnumerable<Resposta> r, int total)
    {
        var opcoes = p.Opcoes.Select(o => CalcularResultadoOpcao(o, r, total)).ToList();
        return new ResultadoPerguntaDto(p.Id, p.Texto, opcoes);
    }

    private static ResultadoOpcaoDto CalcularResultadoOpcao(OpcaoResposta o, IEnumerable<Resposta> r, int total)
    {
        var votos = r.SelectMany(x => x.Itens).Count(i => i.OpcaoRespostaId == o.Id);
        var perc = total > 0 ? (votos * 100.0) / total : 0;
        return new ResultadoOpcaoDto(o.Id, o.Texto, votos, perc);
    }

    private static QuestionarioDto MapearParaDto(Questionario q) => new(
        q.Id, q.Titulo, q.Descricao, q.Status.ToString(), 
        q.PeriodoColeta.DataInicio, q.PeriodoColeta.DataFim, q.DataCriacao, q.DataEncerramento,
        q.Perguntas.Select(p => new PerguntaDto(p.Id, p.Texto, p.Ordem, p.Obrigatoria, 
            p.Opcoes.Select(o => new OpcaoDto(o.Id, o.Texto, o.Ordem)).ToList())).ToList());

    private static QuestionarioPublicoDto MapearParaPublicoDto(Questionario q) => new(
        q.Id, q.Titulo, q.Descricao,
        q.Perguntas.Select(p => new PerguntaDto(p.Id, p.Texto, p.Ordem, p.Obrigatoria,
            p.Opcoes.Select(o => new OpcaoDto(o.Id, o.Texto, o.Ordem)).ToList())).ToList());

    private static QuestionarioListaDto MapearParaListaDto(Questionario q) => new(
        q.Id, q.Titulo, q.Status.ToString(), 
        q.PeriodoColeta.DataInicio, q.PeriodoColeta.DataFim, q.Perguntas.Count);

    private static Result<T> ValidationFailure<T>(FluentValidation.Results.ValidationResult v) =>
        Result.Failure<T>($"Erro de validação: {string.Join("; ", v.Errors.Select(e => e.ErrorMessage))}");
}
