using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using QuestionarioOnline.Api.Responses;
using QuestionarioOnline.Application.DTOs.Requests;
using QuestionarioOnline.Application.DTOs.Responses;
using QuestionarioOnline.Application.Interfaces;

namespace QuestionarioOnline.Api.Controllers;

[Authorize]
[Route("api/[controller]")]
public class QuestionarioController : BaseController
{
    private readonly IQuestionarioService _questionarioService;

    public QuestionarioController(IQuestionarioService questionarioService)
    {
        _questionarioService = questionarioService;
    }

    [HttpPost]
    [Authorize(Roles = "Admin")]
    public async Task<ActionResult<ApiResponse<QuestionarioDto>>> Criar([FromBody] CriarQuestionarioRequest request, CancellationToken cancellationToken)
    {
        var usuarioId = ObterUsuarioIdDoToken();
        var result = await _questionarioService.CriarQuestionarioAsync(request, usuarioId, cancellationToken);
        return FromResult(result);
    }

    [HttpPatch("{id}/status")]
    [Authorize(Roles = "Admin")]
    public async Task<ActionResult<ApiResponse<QuestionarioDto>>> Encerrar(Guid id, CancellationToken cancellationToken)
    {
        var result = await _questionarioService.EncerrarQuestionarioAsync(id, cancellationToken);
        return FromResult(result);
    }

    [HttpDelete("{id}")]
    [Authorize(Roles = "Admin")]
    public async Task<IActionResult> Deletar(Guid id, CancellationToken cancellationToken)
    {
        var result = await _questionarioService.DeletarQuestionarioAsync(id, cancellationToken);

        if (result.IsFailure)
            return FailResponseNoContent(result.Error);

        return NoContent();
    }

    [HttpGet("{id}")]
    public async Task<ActionResult<ApiResponse<QuestionarioDto>>> ObterPorId(Guid id, CancellationToken cancellationToken)
    {
        var result = await _questionarioService.ObterQuestionarioPorIdAsync(id, cancellationToken);
        return FromResult(result);
    }

    [HttpGet]
    public async Task<ActionResult<ApiResponse<IEnumerable<QuestionarioListaDto>>>> Listar(CancellationToken cancellationToken)
    {
        var questionarios = await _questionarioService.ListarTodosQuestionariosAsync(cancellationToken);
        return OkResponse(questionarios);
    }

    [HttpGet("{id}/resultados")]
    [Authorize(Roles = "Admin,Analista,Visualizador")]
    public async Task<ActionResult<ApiResponse<ResultadoQuestionarioDto>>> ObterResultados(Guid id, CancellationToken cancellationToken)
    {
        var result = await _questionarioService.ObterResultadosAsync(id, cancellationToken);
        return FromResult(result);
    }
}
