using QuestionarioOnline.Application.Interfaces;

namespace QuestionarioOnline.Infrastructure.Messaging;

/// <summary>
/// Implementação in-memory da fila para testes unitários.
/// Útil para testar sem dependência de Azure ou outras infraestruturas externas.
/// </summary>
public class InMemoryMessageQueue : IMessageQueue
{
    private readonly Dictionary<string, List<object>> _queues = new();
    private readonly object _lock = new();

    public Task SendAsync<T>(string queueName, T message, CancellationToken cancellationToken = default)
    {
        if (string.IsNullOrWhiteSpace(queueName))
            throw new ArgumentException("Nome da fila não pode ser vazio", nameof(queueName));

        if (message is null)
            throw new ArgumentNullException(nameof(message));

        lock (_lock)
        {
            if (!_queues.ContainsKey(queueName))
                _queues[queueName] = new List<object>();

            _queues[queueName].Add(message);
        }

        return Task.CompletedTask;
    }

    /// <summary>
    /// Método auxiliar para testes - obter mensagens da fila
    /// </summary>
    public List<T> GetMessages<T>(string queueName)
    {
        lock (_lock)
        {
            if (!_queues.ContainsKey(queueName))
                return new List<T>();

            return _queues[queueName].OfType<T>().ToList();
        }
    }

    /// <summary>
    /// Método auxiliar para testes - limpar fila
    /// </summary>
    public void Clear(string queueName)
    {
        lock (_lock)
        {
            if (_queues.ContainsKey(queueName))
                _queues[queueName].Clear();
        }
    }

    /// <summary>
    /// Método auxiliar para testes - limpar todas as filas
    /// </summary>
    public void ClearAll()
    {
        lock (_lock)
        {
            _queues.Clear();
        }
    }
}
