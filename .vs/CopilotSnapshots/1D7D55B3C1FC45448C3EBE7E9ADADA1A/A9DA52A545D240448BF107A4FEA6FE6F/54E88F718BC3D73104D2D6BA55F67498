using Microsoft.EntityFrameworkCore;
using Microsoft.Extensions.DependencyInjection;
using Microsoft.Extensions.Logging;
using QuestionarioOnline.Application.Interfaces;
using QuestionarioOnline.Application.Services;
using QuestionarioOnline.Domain.Interfaces;
using QuestionarioOnline.Infrastructure.Messaging;
using QuestionarioOnline.Infrastructure.Persistence;
using QuestionarioOnline.Infrastructure.Repositories;

namespace QuestionarioOnline.CrossCutting.DependencyInjection;

public static class DependencyInjectionConfig
{
    public static IServiceCollection AddQuestionarioOnlineServices(
        this IServiceCollection services, 
        string connectionString,
        string storageConnectionString)
    {
        // DbContext
        services.AddDbContext<QuestionarioOnlineDbContext>(options =>
            options.UseSqlServer(connectionString));

        // Repositories
        services.AddScoped<IQuestionarioRepository, QuestionarioRepository>();
        services.AddScoped<IRespostaRepository, RespostaRepository>();
        services.AddScoped<IUsuarioInternoRepository, UsuarioInternoRepository>();

        // Message Queue com configurações otimizadas para alto volume
        services.AddSingleton<IMessageQueue>(sp =>
        {
            var logger = sp.GetService<ILogger<AzureQueueStorageAdapter>>();
            
            var options = new MessageQueueOptions
            {
                MaxRetryAttempts = 5,
                VisibilityTimeoutSeconds = 30, // Tempo para processar antes de ficar visível novamente
                MessageTimeToLiveHours = 168, // 7 dias (máximo Azure Queue)
                EnableDeadLetterQueue = true,
                DeadLetterQueueSuffix = "-deadletter",
                EnableTelemetry = true,
                ExponentialBackoffBaseSeconds = 2.0
            };

            return new AzureQueueStorageAdapter(storageConnectionString, options, logger);
        });

        // Services
        services.AddScoped<IQuestionarioService, QuestionarioService>();
        services.AddScoped<IRespostaService, RespostaService>();
        services.AddScoped<IUsuarioInternoService, UsuarioInternoService>();

        return services;
    }
}
