using Microsoft.AspNetCore.Mvc;
using QuestionarioOnline.Infrastructure.Messaging;

namespace QuestionarioOnline.Api.Controllers;

[ApiController]
[Route("api/[controller]")]
public class HealthController : ControllerBase
{
    private readonly IQueueHealthMonitor _healthMonitor;

    public HealthController(IQueueHealthMonitor healthMonitor)
    {
        _healthMonitor = healthMonitor;
    }

    /// <summary>
    /// Verifica saúde da fila de respostas
    /// </summary>
    [HttpGet("queue")]
    [ProducesResponseType(typeof(HealthStatus), StatusCodes.Status200OK)]
    [ProducesResponseType(typeof(HealthStatus), StatusCodes.Status503ServiceUnavailable)]
    public async Task<ActionResult<HealthStatus>> GetQueueHealth(CancellationToken cancellationToken)
    {
        try
        {
            var health = await _healthMonitor.CheckHealthAsync(
                QueueConstants.RespostasQueueName, 
                cancellationToken);
            
            if (!health.IsHealthy)
                return StatusCode(503, health); // Service Unavailable

            return Ok(health);
        }
        catch (Exception ex)
        {
            return StatusCode(500, new
            {
                status = "Error",
                message = $"Erro ao verificar saúde da fila: {ex.Message}"
            });
        }
    }

    /// <summary>
    /// Obtém métricas detalhadas da fila
    /// </summary>
    [HttpGet("queue/metrics")]
    [ProducesResponseType(StatusCodes.Status200OK)]
    public async Task<ActionResult<object>> GetQueueMetrics(CancellationToken cancellationToken)
    {
        try
        {
            var mainQueue = await _healthMonitor.GetMetricsAsync(
                QueueConstants.RespostasQueueName, 
                cancellationToken);
            
            var deadLetter = await _healthMonitor.GetDeadLetterMetricsAsync(
                QueueConstants.RespostasQueueName, 
                cancellationToken: cancellationToken);

            return Ok(new
            {
                mainQueue = new
                {
                    name = mainQueue.QueueName,
                    exists = mainQueue.Exists,
                    messagesCount = mainQueue.ApproximateMessagesCount
                },
                deadLetterQueue = new
                {
                    name = deadLetter.QueueName,
                    exists = deadLetter.Exists,
                    messagesCount = deadLetter.ApproximateMessagesCount
                }
            });
        }
        catch (Exception ex)
        {
            return StatusCode(500, new
            {
                error = $"Erro ao obter métricas: {ex.Message}"
            });
        }
    }

    /// <summary>
    /// Reprocessa mensagens da Dead Letter Queue (uso administrativo)
    /// </summary>
    [HttpPost("queue/reprocess-dead-letter")]
    [ProducesResponseType(StatusCodes.Status200OK)]
    public async Task<ActionResult<object>> ReprocessDeadLetterMessages(
        [FromQuery] int maxMessages = 10,
        CancellationToken cancellationToken = default)
    {
        try
        {
            var result = await _healthMonitor.ReprocessDeadLetterMessagesAsync(
                QueueConstants.RespostasQueueName, 
                maxMessages, 
                cancellationToken);

            return Ok(new
            {
                message = $"{result.ReprocessedCount} mensagens reprocessadas com sucesso",
                reprocessedCount = result.ReprocessedCount,
                failedCount = result.FailedCount,
                totalProcessed = result.TotalProcessed,
                hasFailures = result.HasFailures
            });
        }
        catch (Exception ex)
        {
            return StatusCode(500, new
            {
                error = $"Erro ao reprocessar mensagens: {ex.Message}"
            });
        }
    }
}
