using Microsoft.AspNetCore.Mvc;
using QuestionarioOnline.Application.DTOs;
using QuestionarioOnline.Application.Interfaces;
using UAParser;

namespace QuestionarioOnline.Api.Controllers;

[ApiController]
[Route("api/[controller]")]
public class RespostaController : ControllerBase
{
    private readonly IRespostaService _respostaService;

    public RespostaController(IRespostaService respostaService)
    {
        _respostaService = respostaService;
    }

    /// <summary>
    /// Registrar resposta de questionário (Público - ASSÍNCRONO)
    /// Retorna 202 Accepted imediatamente e processa em background via fila
    /// </summary>
    [HttpPost]
    [ProducesResponseType(StatusCodes.Status202Accepted)]
    [ProducesResponseType(StatusCodes.Status400BadRequest)]
    public async Task<ActionResult<RespostaRegistradaDto>> Registrar(
        [FromBody] RegistrarRespostaRequestPublico request,
        CancellationToken cancellationToken)
    {
        try
        {
            // Capturar dados técnicos
            var ipAddress = ObterIpAddress();
            var userAgent = ObterUserAgent();
            
            // Parsear User-Agent para extrair device/browser
            var (dispositivoTipo, navegadorTipo) = ParsearUserAgent(userAgent);

            var requestCompleto = new RegistrarRespostaRequest(
                request.QuestionarioId,
                request.Respostas,
                ipAddress,
                userAgent,
                request.Estado,
                request.Cidade,
                request.RegiaoGeografica,
                dispositivoTipo,
                navegadorTipo
            );

            var resposta = await _respostaService.RegistrarRespostaAsync(
                requestCompleto, 
                cancellationToken);

            // 202 Accepted - processamento assíncrono
            return AcceptedAtAction(
                nameof(Registrar), 
                new { id = resposta.Id }, 
                new 
                { 
                    mensagem = "Resposta recebida e será processada em breve",
                    resposta 
                });
        }
        catch (InvalidOperationException ex)
        {
            return BadRequest(new { mensagem = ex.Message });
        }
        catch (Exception ex)
        {
            return StatusCode(500, new { mensagem = "Erro ao registrar resposta", detalhe = ex.Message });
        }
    }

    private string ObterIpAddress()
    {
        var forwardedFor = HttpContext.Request.Headers["X-Forwarded-For"].FirstOrDefault();
        if (!string.IsNullOrEmpty(forwardedFor))
        {
            var ips = forwardedFor.Split(',');
            return ips[0].Trim();
        }

        var realIp = HttpContext.Request.Headers["X-Real-IP"].FirstOrDefault();
        if (!string.IsNullOrEmpty(realIp))
            return realIp;

        return HttpContext.Connection.RemoteIpAddress?.ToString() ?? "unknown";
    }

    private string ObterUserAgent()
    {
        return HttpContext.Request.Headers["User-Agent"].FirstOrDefault() ?? "unknown";
    }

    private (string? Dispositivo, string? Navegador) ParsearUserAgent(string userAgent)
    {
        try
        {
            var parser = Parser.GetDefault();
            var clientInfo = parser.Parse(userAgent);
            
            return (
                clientInfo.Device.Family,
                $"{clientInfo.UA.Family} {clientInfo.UA.Major}"
            );
        }
        catch
        {
            return (null, null);
        }
    }
}

// DTO público (frontend envia apenas dados essenciais)
public record RegistrarRespostaRequestPublico(
    Guid QuestionarioId,
    List<RespostaItemDto> Respostas,
    string? Estado,
    string? Cidade,
    string? RegiaoGeografica
);
