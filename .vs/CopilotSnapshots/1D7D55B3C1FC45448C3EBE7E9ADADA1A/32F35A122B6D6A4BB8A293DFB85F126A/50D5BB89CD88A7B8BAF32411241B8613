using QuestionarioOnline.Domain.Enums;
using QuestionarioOnline.Domain.ValueObjects;

namespace QuestionarioOnline.Domain.Entities;

public class Questionario
{
    public Guid Id { get; private set; }
    public string Titulo { get; private set; }
    public string? Descricao { get; private set; }
    public StatusQuestionario Status { get; private set; }
    public PeriodoColeta PeriodoColeta { get; private set; }
    public Guid UsuarioInternoId { get; private set; }
    public DateTime DataCriacao { get; private set; }
    public DateTime? DataPublicacao { get; private set; }
    public DateTime? DataEncerramento { get; private set; }

    private readonly List<Pergunta> _perguntas = new();
    public IReadOnlyCollection<Pergunta> Perguntas => _perguntas.AsReadOnly();

    private Questionario() { }

    public Questionario(string titulo, string? descricao, PeriodoColeta periodoColeta, Guid usuarioInternoId)
    {
        if (string.IsNullOrWhiteSpace(titulo))
            throw new ArgumentException("Título não pode ser vazio", nameof(titulo));

        if (periodoColeta is null)
            throw new ArgumentNullException(nameof(periodoColeta));

        if (usuarioInternoId == Guid.Empty)
            throw new ArgumentException("Usuário interno inválido", nameof(usuarioInternoId));

        Id = Guid.NewGuid();
        Titulo = titulo;
        Descricao = descricao;
        Status = StatusQuestionario.Rascunho;
        PeriodoColeta = periodoColeta;
        UsuarioInternoId = usuarioInternoId;
        DataCriacao = DateTime.UtcNow;
    }

    public void AdicionarPergunta(Pergunta pergunta)
    {
        if (Status != StatusQuestionario.Rascunho)
            throw new InvalidOperationException("Apenas questionários em rascunho podem ter perguntas adicionadas");

        if (pergunta is null)
            throw new ArgumentNullException(nameof(pergunta));

        _perguntas.Add(pergunta);
    }

    public void RemoverPergunta(Guid perguntaId)
    {
        if (Status != StatusQuestionario.Rascunho)
            throw new InvalidOperationException("Apenas questionários em rascunho podem ter perguntas removidas");

        var pergunta = _perguntas.FirstOrDefault(p => p.Id == perguntaId);
        if (pergunta is not null)
            _perguntas.Remove(pergunta);
    }

    public void Publicar()
    {
        if (Status != StatusQuestionario.Rascunho)
            throw new InvalidOperationException("Apenas questionários em rascunho podem ser publicados");

        if (!_perguntas.Any())
            throw new InvalidOperationException("Questionário deve ter pelo menos uma pergunta");

        if (!PeriodoColeta.JaIniciou())
            throw new InvalidOperationException("Período de coleta ainda não iniciou");

        Status = StatusQuestionario.Publicado;
        DataPublicacao = DateTime.UtcNow;
    }

    public void Encerrar()
    {
        if (Status != StatusQuestionario.Publicado)
            throw new InvalidOperationException("Apenas questionários publicados podem ser encerrados");

        Status = StatusQuestionario.Encerrado;
        DataEncerramento = DateTime.UtcNow;
    }

    public bool PodeReceberRespostas()
    {
        return Status == StatusQuestionario.Publicado && PeriodoColeta.EstaAtivo();
    }

    public void AtualizarTitulo(string titulo)
    {
        if (Status != StatusQuestionario.Rascunho)
            throw new InvalidOperationException("Apenas questionários em rascunho podem ter o título alterado");

        if (string.IsNullOrWhiteSpace(titulo))
            throw new ArgumentException("Título não pode ser vazio", nameof(titulo));

        Titulo = titulo;
    }

    public void AtualizarDescricao(string? descricao)
    {
        if (Status != StatusQuestionario.Rascunho)
            throw new InvalidOperationException("Apenas questionários em rascunho podem ter a descrição alterada");

        Descricao = descricao;
    }
}
