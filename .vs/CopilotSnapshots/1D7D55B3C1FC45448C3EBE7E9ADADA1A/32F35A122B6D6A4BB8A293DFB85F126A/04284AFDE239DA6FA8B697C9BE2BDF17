using Azure.Storage.Queues;
using QuestionarioOnline.Application.DTOs;
using QuestionarioOnline.Application.Interfaces;
using System.Text.Json;

namespace QuestionarioOnline.Infrastructure.Services;

public class FilaRespostaService : IFilaRespostaService
{
    private readonly QueueClient _queueClient;

    public FilaRespostaService(string connectionString, string queueName = "respostas-questionario")
    {
        _queueClient = new QueueClient(connectionString, queueName);
        _queueClient.CreateIfNotExists();
    }

    public async Task EnfileirarRespostaAsync(RespostaParaProcessamentoDto mensagem, CancellationToken cancellationToken = default)
    {
        var json = JsonSerializer.Serialize(mensagem);
        
        // Base64 encode para evitar problemas com caracteres especiais
        var bytes = System.Text.Encoding.UTF8.GetBytes(json);
        var base64 = Convert.ToBase64String(bytes);

        await _queueClient.SendMessageAsync(base64, cancellationToken);
    }
}
