using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using QuestionarioOnline.Api.Responses;
using QuestionarioOnline.Application.DTOs.Requests;
using QuestionarioOnline.Application.DTOs.Responses;
using QuestionarioOnline.Application.Interfaces;
using QuestionarioOnline.Application.Validators;
using System.Security.Claims;

namespace QuestionarioOnline.Api.Controllers;

[Authorize]
[Route("api/[controller]")]
public class QuestionarioController : BaseController
{
    private readonly IQuestionarioService _questionarioService;
    private readonly CriarQuestionarioRequestValidator _criarQuestionarioValidator;

    public QuestionarioController(
        IQuestionarioService questionarioService,
        CriarQuestionarioRequestValidator criarQuestionarioValidator)
    {
        _questionarioService = questionarioService;
        _criarQuestionarioValidator = criarQuestionarioValidator;
    }

    [HttpPost]
    [ProducesResponseType(typeof(ApiResponse<QuestionarioDto>), StatusCodes.Status201Created)]
    [ProducesResponseType(typeof(ApiResponse<QuestionarioDto>), StatusCodes.Status400BadRequest)]
    public async Task<ActionResult<ApiResponse<QuestionarioDto>>> Criar(
        [FromBody] CriarQuestionarioRequest request,
        CancellationToken cancellationToken)
    {
        var validationResult = await _criarQuestionarioValidator.ValidateAsync(request, cancellationToken);
        
        if (!validationResult.IsValid)
            return ValidationErrorResponse<QuestionarioDto>(validationResult);

        var usuarioId = ObterUsuarioIdDoToken();
        var result = await _questionarioService.CriarQuestionarioAsync(request, usuarioId, cancellationToken);

        if (result.IsFailure)
            return FailResponse(result);

        return CreatedResponse(nameof(ObterPorId), new { id = result.Value.Id }, result.Value);
    }

    [HttpPost("{id}/encerrar")]
    [ProducesResponseType(typeof(ApiResponse<QuestionarioDto>), StatusCodes.Status200OK)]
    [ProducesResponseType(typeof(ApiResponse<QuestionarioDto>), StatusCodes.Status400BadRequest)]
    public async Task<ActionResult<ApiResponse<QuestionarioDto>>> Encerrar(Guid id, CancellationToken cancellationToken)
    {
        var usuarioId = ObterUsuarioIdDoToken();
        var result = await _questionarioService.EncerrarQuestionarioAsync(id, usuarioId, cancellationToken);
        return FromResult(result);
    }

    [AllowAnonymous]
    [HttpGet("publico/{id}")]
    [ProducesResponseType(typeof(ApiResponse<QuestionarioPublicoDto>), StatusCodes.Status200OK)]
    [ProducesResponseType(typeof(ApiResponse<QuestionarioPublicoDto>), StatusCodes.Status404NotFound)]
    public async Task<ActionResult<ApiResponse<QuestionarioPublicoDto>>> ObterPublico(Guid id, CancellationToken cancellationToken)
    {
        var questionario = await _questionarioService.ObterQuestionarioPublicoAsync(id, cancellationToken);
        
        if (questionario is null)
            return NotFoundResponse<QuestionarioPublicoDto>("Questionário não encontrado ou não está disponível");

        return OkResponse(questionario);
    }

    [HttpGet("{id}")]
    [ProducesResponseType(typeof(ApiResponse<QuestionarioDto>), StatusCodes.Status200OK)]
    [ProducesResponseType(typeof(ApiResponse<QuestionarioDto>), StatusCodes.Status404NotFound)]
    public async Task<ActionResult<ApiResponse<QuestionarioDto>>> ObterPorId(Guid id, CancellationToken cancellationToken)
    {
        var usuarioId = ObterUsuarioIdDoToken();
        var questionario = await _questionarioService.ObterQuestionarioPorIdAsync(id, usuarioId, cancellationToken);
        
        if (questionario is null)
            return NotFoundResponse<QuestionarioDto>("Questionário não encontrado");

        return OkResponse(questionario);
    }

    [HttpGet]
    [ProducesResponseType(typeof(ApiResponse<IEnumerable<QuestionarioListaDto>>), StatusCodes.Status200OK)]
    public async Task<ActionResult<ApiResponse<IEnumerable<QuestionarioListaDto>>>> Listar(CancellationToken cancellationToken)
    {
        var usuarioId = ObterUsuarioIdDoToken();
        var questionarios = await _questionarioService.ListarQuestionariosPorUsuarioAsync(usuarioId, cancellationToken);
        return OkResponse(questionarios);
    }

    [HttpGet("{id}/resultados")]
    [Authorize(Roles = "Admin,Analista,Visualizador")]
    [ProducesResponseType(typeof(ApiResponse<ResultadoQuestionarioDto>), StatusCodes.Status200OK)]
    [ProducesResponseType(typeof(ApiResponse<ResultadoQuestionarioDto>), StatusCodes.Status404NotFound)]
    [ProducesResponseType(typeof(ApiResponse<ResultadoQuestionarioDto>), StatusCodes.Status401Unauthorized)]
    public async Task<ActionResult<ApiResponse<ResultadoQuestionarioDto>>> ObterResultados(Guid id, CancellationToken cancellationToken)
    {
        try
        {
            var usuarioId = ObterUsuarioIdDoToken();
            var userRole = User.FindFirst(ClaimTypes.Role)?.Value;
            
            var resultado = await _questionarioService.ObterResultadosAsync(id, usuarioId, cancellationToken);
            
            if (userRole != "Admin" && userRole != "Visualizador")
            {
                var questionario = await _questionarioService.ObterQuestionarioPorIdAsync(id, usuarioId, cancellationToken);
                if (questionario == null)
                    return NotFoundResponse<ResultadoQuestionarioDto>("Questionário não encontrado");
            }
            
            return OkResponse(resultado);
        }
        catch (InvalidOperationException ex)
        {
            return NotFoundResponse<ResultadoQuestionarioDto>(ex.Message);
        }
        catch (UnauthorizedAccessException ex)
        {
            return UnauthorizedResponse<ResultadoQuestionarioDto>(ex.Message);
        }
    }
}
