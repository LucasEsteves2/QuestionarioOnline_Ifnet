using Microsoft.AspNetCore.Mvc;
using QuestionarioOnline.Api.Requests;
using QuestionarioOnline.Api.Responses;
using QuestionarioOnline.Application.DTOs;
using QuestionarioOnline.Application.Interfaces;
using UAParser;

namespace QuestionarioOnline.Api.Controllers;

[Route("api/[controller]")]
public class RespostaController : BaseController
{
    private readonly IRespostaService _respostaService;

    public RespostaController(IRespostaService respostaService)
    {
        _respostaService = respostaService;
    }

    /// <summary>
    /// Registrar resposta de questionário (Público - ASSÍNCRONO)
    /// Retorna 202 Accepted imediatamente e processa em background via fila
    /// ✅ Response padronizado com ApiResponse
    /// </summary>
    [HttpPost]
    [ProducesResponseType(typeof(ApiResponse<RespostaRegistradaDto>), StatusCodes.Status202Accepted)]
    [ProducesResponseType(typeof(ApiResponse<RespostaRegistradaDto>), StatusCodes.Status400BadRequest)]
    public async Task<ActionResult<ApiResponse<RespostaRegistradaDto>>> Registrar(
        [FromBody] RegistrarRespostaApiRequest apiRequest,
        CancellationToken cancellationToken)
    {
        // 1️⃣ Controller captura dados técnicos (responsabilidade da camada de apresentação)
        var ipAddress = ObterIpAddress();
        var userAgent = ObterUserAgent();
        var (dispositivoTipo, navegadorTipo) = ParsearUserAgent(userAgent);

        // 2️⃣ Mapeia Request da API para DTO da Application
        var applicationRequest = new RegistrarRespostaRequest(
            apiRequest.QuestionarioId,
            apiRequest.Respostas.Select(r => new RespostaItemDto(
                r.PerguntaId,
                r.OpcaoRespostaId
            )).ToList(),
            ipAddress,
            userAgent,
            apiRequest.Estado,
            apiRequest.Cidade,
            apiRequest.RegiaoGeografica,
            dispositivoTipo,
            navegadorTipo
        );

        // 3️⃣ Chama Application Service (retorna Result, não exception)
        var result = await _respostaService.RegistrarRespostaAsync(
            applicationRequest, 
            cancellationToken);

        // 4️⃣ Retorna response padronizado
        if (result.IsFailure)
        {
            return FailResponse(result);
        }

        // 5️⃣ Retorna 202 Accepted (processamento assíncrono)
        return AcceptedResponse(
            result.Value,
            "Resposta recebida e será processada em breve");
    }

    #region Métodos Privados (Responsabilidade do Controller)

    private string ObterIpAddress()
    {
        var forwardedFor = HttpContext.Request.Headers["X-Forwarded-For"].FirstOrDefault();
        if (!string.IsNullOrEmpty(forwardedFor))
        {
            var ips = forwardedFor.Split(',');
            return ips[0].Trim();
        }

        var realIp = HttpContext.Request.Headers["X-Real-IP"].FirstOrDefault();
        if (!string.IsNullOrEmpty(realIp))
            return realIp;

        return HttpContext.Connection.RemoteIpAddress?.ToString() ?? "unknown";
    }

    private string ObterUserAgent()
    {
        return HttpContext.Request.Headers["User-Agent"].FirstOrDefault() ?? "unknown";
    }

    private (string? Dispositivo, string? Navegador) ParsearUserAgent(string userAgent)
    {
        try
        {
            var parser = Parser.GetDefault();
            var clientInfo = parser.Parse(userAgent);
            
            return (
                clientInfo.Device.Family,
                $"{clientInfo.UA.Family} {clientInfo.UA.Major}"
            );
        }
        catch
        {
            return (null, null);
        }
    }

    #endregion
}

// DTO público (frontend envia apenas dados essenciais)
public record RegistrarRespostaRequestPublico(
    Guid QuestionarioId,
    List<RespostaItemDto> Respostas,
    string? Estado,
    string? Cidade,
    string? RegiaoGeografica
);
