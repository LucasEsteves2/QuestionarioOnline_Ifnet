using Microsoft.AspNetCore.Mvc;
using QuestionarioOnline.Application.DTOs;
using QuestionarioOnline.Application.Interfaces;

namespace QuestionarioOnline.Api.Controllers;

[ApiController]
[Route("api/[controller]")]
public class RespostaController : ControllerBase
{
    private readonly IRespostaService _respostaService;

    public RespostaController(IRespostaService respostaService)
    {
        _respostaService = respostaService;
    }

    /// <summary>
    /// Registrar resposta de questionário (Público - sem autenticação)
    /// </summary>
    [HttpPost]
    public async Task<ActionResult<RespostaRegistradaDto>> Registrar(
        [FromBody] RegistrarRespostaRequest request,
        CancellationToken cancellationToken)
    {
        try
        {
            // Capturar IP e User-Agent do respondente
            var ipAddress = ObterIpAddress();
            var userAgent = ObterUserAgent();

            var requestComOrigem = request with 
            { 
                IpAddress = ipAddress, 
                UserAgent = userAgent 
            };

            var resposta = await _respostaService.RegistrarRespostaAsync(
                requestComOrigem, 
                cancellationToken);

            return CreatedAtAction(
                nameof(Registrar), 
                new { id = resposta.Id }, 
                resposta);
        }
        catch (InvalidOperationException ex)
        {
            return BadRequest(new { mensagem = ex.Message });
        }
        catch (Exception ex)
        {
            return StatusCode(500, new { mensagem = "Erro ao registrar resposta", detalhe = ex.Message });
        }
    }

    private string ObterIpAddress()
    {
        // Tentar obter o IP real através de headers de proxy
        var forwardedFor = HttpContext.Request.Headers["X-Forwarded-For"].FirstOrDefault();
        if (!string.IsNullOrEmpty(forwardedFor))
        {
            var ips = forwardedFor.Split(',');
            return ips[0].Trim();
        }

        var realIp = HttpContext.Request.Headers["X-Real-IP"].FirstOrDefault();
        if (!string.IsNullOrEmpty(realIp))
            return realIp;

        // Fallback para IP da conexão
        return HttpContext.Connection.RemoteIpAddress?.ToString() ?? "unknown";
    }

    private string ObterUserAgent()
    {
        return HttpContext.Request.Headers["User-Agent"].FirstOrDefault() ?? "unknown";
    }
}
