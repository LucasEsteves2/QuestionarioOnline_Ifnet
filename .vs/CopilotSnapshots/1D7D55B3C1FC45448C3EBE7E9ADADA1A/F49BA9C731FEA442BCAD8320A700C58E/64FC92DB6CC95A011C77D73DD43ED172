using QuestionarioOnline.Domain.ValueObjects;

namespace QuestionarioOnline.Domain.Entities;

public class Resposta
{
    public Guid Id { get; private set; }
    public Guid QuestionarioId { get; private set; }
    public OrigemResposta OrigemResposta { get; private set; }
    public DateTime DataResposta { get; private set; }

    private readonly List<RespostaItem> _itens = new();
    public IReadOnlyCollection<RespostaItem> Itens => _itens.AsReadOnly();

    private Resposta() { }

    public Resposta(Guid questionarioId, OrigemResposta origemResposta)
    {
        if (questionarioId == Guid.Empty)
            throw new ArgumentException("Questionário inválido", nameof(questionarioId));

        if (origemResposta is null)
            throw new ArgumentNullException(nameof(origemResposta));

        Id = Guid.NewGuid();
        QuestionarioId = questionarioId;
        OrigemResposta = origemResposta;
        DataResposta = DateTime.UtcNow;
    }

    public void AdicionarItem(RespostaItem item)
    {
        if (item is null)
            throw new ArgumentNullException(nameof(item));

        if (_itens.Any(i => i.PerguntaId == item.PerguntaId))
            throw new InvalidOperationException("Já existe uma resposta para esta pergunta");

        _itens.Add(item);
    }

    public void ValidarCompletude(IEnumerable<Pergunta> perguntas)
    {
        var perguntasObrigatorias = perguntas.Where(p => p.Obrigatoria).Select(p => p.Id).ToList();
        var perguntasRespondidas = _itens.Select(i => i.PerguntaId).ToList();

        var perguntasFaltantes = perguntasObrigatorias.Except(perguntasRespondidas).ToList();

        if (perguntasFaltantes.Any())
            throw new InvalidOperationException("Existem perguntas obrigatórias não respondidas");
    }
}
