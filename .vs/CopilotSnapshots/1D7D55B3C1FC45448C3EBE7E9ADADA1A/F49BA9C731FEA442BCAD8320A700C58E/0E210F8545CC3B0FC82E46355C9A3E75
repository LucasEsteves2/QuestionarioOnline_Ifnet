using QuestionarioOnline.Application.DTOs;
using QuestionarioOnline.Application.Interfaces;
using QuestionarioOnline.Domain.Entities;
using QuestionarioOnline.Domain.Interfaces;
using QuestionarioOnline.Domain.ValueObjects;

namespace QuestionarioOnline.Application.Services;

public class RespostaService : IRespostaService
{
    private readonly IRespostaRepository _respostaRepository;
    private readonly IQuestionarioRepository _questionarioRepository;

    public RespostaService(
        IRespostaRepository respostaRepository,
        IQuestionarioRepository questionarioRepository)
    {
        _respostaRepository = respostaRepository;
        _questionarioRepository = questionarioRepository;
    }

    public async Task<RespostaRegistradaDto> RegistrarRespostaAsync(RegistrarRespostaRequest request, CancellationToken cancellationToken = default)
    {
        var questionario = await _questionarioRepository.ObterPorIdComPerguntasAsync(request.QuestionarioId, cancellationToken);

        if (questionario is null)
            throw new InvalidOperationException("Questionário não encontrado");

        if (!questionario.PodeReceberRespostas())
            throw new InvalidOperationException("Questionário não está disponível para receber respostas");

        var origemResposta = OrigemResposta.Create(request.IpAddress, request.UserAgent);

        var jaRespondeu = await _respostaRepository.JaRespondeuAsync(request.QuestionarioId, origemResposta, cancellationToken);

        if (jaRespondeu)
            throw new InvalidOperationException("Você já respondeu este questionário");

        var resposta = new Resposta(request.QuestionarioId, origemResposta);

        foreach (var item in request.Respostas)
        {
            var respostaItem = new RespostaItem(resposta.Id, item.PerguntaId, item.OpcaoRespostaId);
            resposta.AdicionarItem(respostaItem);
        }

        resposta.ValidarCompletude(questionario.Perguntas);

        await _respostaRepository.AdicionarAsync(resposta, cancellationToken);

        return new RespostaRegistradaDto(
            resposta.Id,
            resposta.QuestionarioId,
            resposta.DataResposta
        );
    }
}
