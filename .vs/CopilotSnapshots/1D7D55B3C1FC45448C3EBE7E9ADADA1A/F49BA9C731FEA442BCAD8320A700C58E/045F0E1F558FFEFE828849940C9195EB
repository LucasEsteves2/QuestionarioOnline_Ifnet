using Microsoft.EntityFrameworkCore;
using QuestionarioOnline.Domain.Entities;
using QuestionarioOnline.Domain.ValueObjects;

namespace QuestionarioOnline.Infrastructure.Persistence;

public class QuestionarioOnlineDbContext : DbContext
{
    public QuestionarioOnlineDbContext(DbContextOptions<QuestionarioOnlineDbContext> options)
        : base(options)
    {
    }

    public DbSet<UsuarioInterno> UsuariosInternos => Set<UsuarioInterno>();
    public DbSet<Questionario> Questionarios => Set<Questionario>();
    public DbSet<Pergunta> Perguntas => Set<Pergunta>();
    public DbSet<OpcaoResposta> OpcoesResposta => Set<OpcaoResposta>();
    public DbSet<Resposta> Respostas => Set<Resposta>();
    public DbSet<RespostaItem> RespostaItens => Set<RespostaItem>();

    protected override void OnModelCreating(ModelBuilder modelBuilder)
    {
        base.OnModelCreating(modelBuilder);

        // Configuração UsuarioInterno
        modelBuilder.Entity<UsuarioInterno>(entity =>
        {
            entity.HasKey(e => e.Id);
            entity.Property(e => e.Nome).IsRequired().HasMaxLength(200);
            entity.Property(e => e.SenhaHash).IsRequired().HasMaxLength(64);
            entity.Property(e => e.DataCriacao).IsRequired();
            entity.Property(e => e.Ativo).IsRequired();

            entity.OwnsOne(e => e.Email, email =>
            {
                email.Property(e => e.Address)
                    .HasColumnName("Email")
                    .IsRequired()
                    .HasMaxLength(255);

                email.HasIndex(e => e.Address).IsUnique();
            });
        });

        // Configuração Questionario
        modelBuilder.Entity<Questionario>(entity =>
        {
            entity.HasKey(e => e.Id);
            entity.Property(e => e.Titulo).IsRequired().HasMaxLength(500);
            entity.Property(e => e.Descricao).HasMaxLength(2000);
            entity.Property(e => e.Status).IsRequired();
            entity.Property(e => e.UsuarioInternoId).IsRequired();
            entity.Property(e => e.DataCriacao).IsRequired();

            entity.OwnsOne(e => e.PeriodoColeta, periodo =>
            {
                periodo.Property(p => p.DataInicio)
                    .HasColumnName("DataInicio")
                    .IsRequired();

                periodo.Property(p => p.DataFim)
                    .HasColumnName("DataFim")
                    .IsRequired();
            });

            entity.HasMany(e => e.Perguntas)
                .WithOne()
                .HasForeignKey(p => p.QuestionarioId)
                .OnDelete(DeleteBehavior.Cascade);
        });

        // Configuração Pergunta
        modelBuilder.Entity<Pergunta>(entity =>
        {
            entity.HasKey(e => e.Id);
            entity.Property(e => e.QuestionarioId).IsRequired();
            entity.Property(e => e.Texto).IsRequired().HasMaxLength(1000);
            entity.Property(e => e.Ordem).IsRequired();
            entity.Property(e => e.Obrigatoria).IsRequired();

            entity.HasMany(e => e.Opcoes)
                .WithOne()
                .HasForeignKey(o => o.PerguntaId)
                .OnDelete(DeleteBehavior.Cascade);
        });

        // Configuração OpcaoResposta
        modelBuilder.Entity<OpcaoResposta>(entity =>
        {
            entity.HasKey(e => e.Id);
            entity.Property(e => e.PerguntaId).IsRequired();
            entity.Property(e => e.Texto).IsRequired().HasMaxLength(500);
            entity.Property(e => e.Ordem).IsRequired();
        });

        // Configuração Resposta
        modelBuilder.Entity<Resposta>(entity =>
        {
            entity.HasKey(e => e.Id);
            entity.Property(e => e.QuestionarioId).IsRequired();
            entity.Property(e => e.DataResposta).IsRequired();

            entity.OwnsOne(e => e.OrigemResposta, origem =>
            {
                origem.Property(o => o.Hash)
                    .HasColumnName("OrigemHash")
                    .IsRequired()
                    .HasMaxLength(64);
            });

            entity.HasMany(e => e.Itens)
                .WithOne()
                .HasForeignKey(i => i.RespostaId)
                .OnDelete(DeleteBehavior.Cascade);

            entity.HasIndex(e => new { e.QuestionarioId, e.OrigemResposta })
                .HasDatabaseName("IX_Resposta_Questionario_Origem");
        });

        // Configuração RespostaItem
        modelBuilder.Entity<RespostaItem>(entity =>
        {
            entity.HasKey(e => e.Id);
            entity.Property(e => e.RespostaId).IsRequired();
            entity.Property(e => e.PerguntaId).IsRequired();
            entity.Property(e => e.OpcaoRespostaId).IsRequired();
        });
    }
}
