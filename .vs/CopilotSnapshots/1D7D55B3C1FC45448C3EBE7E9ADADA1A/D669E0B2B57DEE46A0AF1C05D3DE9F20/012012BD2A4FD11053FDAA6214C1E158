using QuestionarioOnline.Application.DTOs.Requests;
using QuestionarioOnline.Application.DTOs.Responses;
using QuestionarioOnline.Application.Interfaces;
using QuestionarioOnline.Domain.Entities;
using QuestionarioOnline.Domain.Interfaces;
using QuestionarioOnline.Domain.ValueObjects;

namespace QuestionarioOnline.Application.Services;

public class AuthService : IAuthService
{
    private readonly IUsuarioRepository _usuarioRepository;
    private readonly Api.Services.AuthService _jwtService;

    public AuthService(IUsuarioRepository usuarioRepository, Api.Services.AuthService jwtService)
    {
        _usuarioRepository = usuarioRepository;
        _jwtService = jwtService;
    }

    public async Task<Result<UsuarioRegistradoDto>> RegistrarAsync(RegistrarUsuarioRequest request)
    {
        // Validar email
        var email = Email.Create(request.Email);

        // Verificar se já existe
        var usuarioExistente = await _usuarioRepository.ObterPorEmailAsync(email);
        if (usuarioExistente != null)
            return Result<UsuarioRegistradoDto>.Failure("Email já cadastrado");

        // Hash da senha
        var senhaHash = BCrypt.Net.BCrypt.HashPassword(request.Senha);

        // Criar entidade de domínio
        var novoUsuario = new Usuario(
            request.Nome,
            email,
            senhaHash
        );

        // Persistir
        await _usuarioRepository.AdicionarAsync(novoUsuario);

        // Retornar DTO
        var dto = new UsuarioRegistradoDto(
            novoUsuario.Id,
            novoUsuario.Nome,
            novoUsuario.Email.Address
        );

        return Result<UsuarioRegistradoDto>.Success(dto);
    }

    public async Task<Result<LoginResponse>> LoginAsync(LoginRequest request)
    {
        // Validar email
        var email = Email.Create(request.Email);

        // Buscar usuário
        var usuario = await _usuarioRepository.ObterPorEmailAsync(email);
        if (usuario == null)
            return Result<LoginResponse>.Failure("Email ou senha inválidos");

        // Verificar se está ativo
        if (!usuario.Ativo)
            return Result<LoginResponse>.Failure("Usuário inativo");

        // Validar senha
        var senhaValida = BCrypt.Net.BCrypt.Verify(request.Senha, usuario.SenhaHash);
        if (!senhaValida)
            return Result<LoginResponse>.Failure("Email ou senha inválidos");

        // Gerar token JWT
        var token = _jwtService.GerarToken(usuario);

        // Retornar DTO
        var response = new LoginResponse(
            token,
            usuario.Id,
            usuario.Nome,
            usuario.Email.ToString()
        );

        return Result<LoginResponse>.Success(response);
    }
}
