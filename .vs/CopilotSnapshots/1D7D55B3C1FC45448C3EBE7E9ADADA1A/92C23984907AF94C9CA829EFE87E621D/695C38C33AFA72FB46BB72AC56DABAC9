using FluentValidation;
using QuestionarioOnline.Application.DTOs.Requests;

namespace QuestionarioOnline.Application.Validators;

/// <summary>
/// ✅ Validador para CriarQuestionarioRequest
/// 
/// REGRAS:
/// - Titulo: obrigatório, entre 3 e 200 caracteres
/// - Descricao: opcional, max 1000 caracteres
/// - DataInicio: obrigatória, antes de DataFim
/// - DataFim: obrigatória, futura (> hoje)
/// - Perguntas: obrigatório, mínimo 1 pergunta
/// - Perguntas[].Texto: obrigatório, max 500 caracteres
/// - Perguntas[].Opcoes: obrigatório, mínimo 2 opções
/// - Perguntas[].Opcoes[].Texto: obrigatório, max 500 caracteres
/// </summary>
public class CriarQuestionarioRequestValidator : AbstractValidator<CriarQuestionarioRequest>
{
    public CriarQuestionarioRequestValidator()
    {
        // ✅ TÍTULO
        RuleFor(x => x.Titulo)
            .NotEmpty().WithMessage("Título é obrigatório")
            .Length(3, 200).WithMessage("Título deve ter entre 3 e 200 caracteres");

        // ✅ DESCRIÇÃO (opcional)
        RuleFor(x => x.Descricao)
            .MaximumLength(1000).WithMessage("Descrição deve ter no máximo 1000 caracteres")
            .When(x => !string.IsNullOrEmpty(x.Descricao));

        // ✅ DATA INÍCIO
        RuleFor(x => x.DataInicio)
            .NotEmpty().WithMessage("Data de início é obrigatória")
            .LessThan(x => x.DataFim).WithMessage("Data de início deve ser anterior à data de fim");

        // ✅ DATA FIM
        RuleFor(x => x.DataFim)
            .NotEmpty().WithMessage("Data de fim é obrigatória")
            .GreaterThan(DateTime.UtcNow).WithMessage("Data de fim deve ser futura");

        // ✅ PERGUNTAS
        RuleFor(x => x.Perguntas)
            .NotEmpty().WithMessage("Questionário deve ter pelo menos uma pergunta")
            .Must(perguntas => perguntas != null && perguntas.Count >= 1)
            .WithMessage("Questionário deve ter pelo menos uma pergunta");

        // ✅ VALIDAÇÃO DE CADA PERGUNTA
        RuleForEach(x => x.Perguntas)
            .ChildRules(pergunta =>
            {
                // Texto da pergunta
                pergunta.RuleFor(p => p.Texto)
                    .NotEmpty().WithMessage("Texto da pergunta é obrigatório")
                    .MaximumLength(500).WithMessage("Texto da pergunta deve ter no máximo 500 caracteres");

                // Ordem da pergunta
                pergunta.RuleFor(p => p.Ordem)
                    .GreaterThanOrEqualTo(0).WithMessage("Ordem deve ser maior ou igual a zero");

                // Opções da pergunta
                pergunta.RuleFor(p => p.Opcoes)
                    .NotEmpty().WithMessage("Pergunta deve ter opções")
                    .Must(opcoes => opcoes != null && opcoes.Count >= 2)
                    .WithMessage("Pergunta deve ter pelo menos duas opções");

                // ✅ VALIDAÇÃO DE CADA OPÇÃO
                pergunta.RuleForEach(p => p.Opcoes)
                    .ChildRules(opcao =>
                    {
                        // Texto da opção
                        opcao.RuleFor(o => o.Texto)
                            .NotEmpty().WithMessage("Texto da opção é obrigatório")
                            .MaximumLength(500).WithMessage("Texto da opção deve ter no máximo 500 caracteres");

                        // Ordem da opção
                        opcao.RuleFor(o => o.Ordem)
                            .GreaterThanOrEqualTo(0).WithMessage("Ordem deve ser maior ou igual a zero");
                    });
            });
    }
}
