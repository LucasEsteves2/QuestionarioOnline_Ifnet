using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using QuestionarioOnline.Api.Responses;
using QuestionarioOnline.Api.Services;
using QuestionarioOnline.Application.DTOs.Requests;
using QuestionarioOnline.Application.DTOs.Responses;
using QuestionarioOnline.Domain.Entities;
using QuestionarioOnline.Domain.Interfaces;
using QuestionarioOnline.Domain.ValueObjects;

namespace QuestionarioOnline.Api.Controllers;

[AllowAnonymous]
[Route("api/[controller]")]
public class AuthController : BaseController
{
    private readonly AuthService _authService;
    private readonly IUsuarioInternoRepository _usuarioRepository;

    public AuthController(AuthService authService, IUsuarioInternoRepository usuarioRepository)
    {
        _authService = authService;
        _usuarioRepository = usuarioRepository;
    }

    [HttpPost("register")]
    [ProducesResponseType(typeof(ApiResponse<object>), StatusCodes.Status201Created)]
    [ProducesResponseType(typeof(ApiResponse<object>), StatusCodes.Status400BadRequest)]
    public async Task<ActionResult<ApiResponse<object>>> Register([FromBody] RegistrarUsuarioRequest request)
    {
        var email = Email.Create(request.Email);

        var usuarioExistente = await _usuarioRepository.ObterPorEmailAsync(email);
        if (usuarioExistente != null)
            return FailResponse<object>("Email já cadastrado");

        var senhaHash = BCrypt.Net.BCrypt.HashPassword(request.Senha);

        var novoUsuario = new UsuarioInterno(
            request.Nome,
            email,
            senhaHash
        );

        await _usuarioRepository.AdicionarAsync(novoUsuario);

        var data = new
        {
            usuarioId = novoUsuario.Id,
            nome = novoUsuario.Nome,
            email = novoUsuario.Email.Address
        };

        return CreatedResponse(
            nameof(Login),
            null,
            data,
            "Usuário cadastrado com sucesso. Faça login para obter o token."
        );
    }

    [HttpPost("login")]
    [ProducesResponseType(typeof(ApiResponse<LoginResponse>), StatusCodes.Status200OK)]
    [ProducesResponseType(typeof(ApiResponse<LoginResponse>), StatusCodes.Status401Unauthorized)]
    public async Task<ActionResult<ApiResponse<LoginResponse>>> Login([FromBody] LoginRequest request)
    {
        var email = Email.Create(request.Email);

        var usuario = await _usuarioRepository.ObterPorEmailAsync(email);
        if (usuario == null)
            return UnauthorizedResponse<LoginResponse>("Email ou senha inválidos");

        if (!usuario.Ativo)
            return UnauthorizedResponse<LoginResponse>("Usuário inativo");

        var senhaValida = BCrypt.Net.BCrypt.Verify(request.Senha, usuario.SenhaHash);
        if (!senhaValida)
            return UnauthorizedResponse<LoginResponse>("Email ou senha inválidos");

        var token = _authService.GerarToken(usuario);

        var response = new LoginResponse(
            token,
            usuario.Id,
            usuario.Nome,
            usuario.Email.ToString()
        );

        return OkResponse(response, "Login realizado com sucesso");
    }
}
