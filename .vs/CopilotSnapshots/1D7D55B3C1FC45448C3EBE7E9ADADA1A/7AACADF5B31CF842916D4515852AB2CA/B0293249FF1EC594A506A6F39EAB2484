using QuestionarioOnline.Application.DTOs;
using QuestionarioOnline.Application.Interfaces;
using QuestionarioOnline.Domain.Common;
using QuestionarioOnline.Domain.Constants;
using QuestionarioOnline.Domain.Interfaces;
using QuestionarioOnline.Domain.ValueObjects;

namespace QuestionarioOnline.Application.Services;

public class RespostaService : IRespostaService
{
    private readonly IMessageQueue _messageQueue;
    private readonly IQuestionarioRepository _questionarioRepository;
    private readonly IRespostaRepository _respostaRepository;

    public RespostaService(
        IMessageQueue messageQueue,
        IQuestionarioRepository questionarioRepository,
        IRespostaRepository respostaRepository)
    {
        _messageQueue = messageQueue;
        _questionarioRepository = questionarioRepository;
        _respostaRepository = respostaRepository;
    }

    /// <summary>
    /// Registra resposta de forma ASSÍNCRONA usando fila
    /// Retorna Result com sucesso ou falha (sem exceptions)
    /// </summary>
    public async Task<Result<RespostaRegistradaDto>> RegistrarRespostaAsync(
        RegistrarRespostaRequest request,
        CancellationToken cancellationToken = default)
    {
        // 1️⃣ Validação rápida - verifica se questionário existe
        var questionario = await _questionarioRepository.ObterPorIdAsync(request.QuestionarioId, cancellationToken);

        if (questionario is null)
            return Result.Failure<RespostaRegistradaDto>("Questionário não encontrado");

        // 2️⃣ Verifica se questionário está ativo
        if (!questionario.PodeReceberRespostas())
            return Result.Failure<RespostaRegistradaDto>("Questionário não está disponível para receber respostas");

        // 3️⃣ Verificação de duplicação (evita spam)
        var origemResposta = OrigemResposta.Create(request.IpAddress, request.UserAgent);
        var jaRespondeu = await _respostaRepository.JaRespondeuAsync(
            request.QuestionarioId,
            origemResposta,
            cancellationToken);

        if (jaRespondeu)
            return Result.Failure<RespostaRegistradaDto>("Você já respondeu este questionário");

        // 4️⃣ Enfileirar para processamento assíncrono (NÃO BLOQUEIA)
        var mensagem = new RespostaParaProcessamentoDto(
            request.QuestionarioId,
            request.Respostas,
            request.IpAddress,
            request.UserAgent,
            request.Estado,
            request.Cidade,
            request.RegiaoGeografica,
            request.DispositivoTipo,
            request.NavegadorTipo
        );

        await _messageQueue.SendAsync(QueueConstants.RespostasQueueName, mensagem, cancellationToken);

        // 5️⃣ Retornar sucesso imediatamente (202 Accepted)
        var resposta = new RespostaRegistradaDto(
            Guid.NewGuid(), // ID temporário (o real será gerado pelo worker)
            request.QuestionarioId,
            DateTime.UtcNow
        );

        return Result.Success(resposta);
    }
}
