using FluentValidation;
using Microsoft.AspNetCore.Mvc;
using QuestionarioOnline.Api.Requests;
using QuestionarioOnline.Application.DTOs;
using QuestionarioOnline.Application.Interfaces;
using UAParser;

namespace QuestionarioOnline.Api.Controllers;

[ApiController]
[Route("api/[controller]")]
public class RespostaController : ControllerBase
{
    private readonly IRespostaService _respostaService;
    private readonly IValidator<RegistrarRespostaApiRequest> _validator;

    public RespostaController(
        IRespostaService respostaService,
        IValidator<RegistrarRespostaApiRequest> validator)
    {
        _respostaService = respostaService;
        _validator = validator;
    }

    /// <summary>
    /// Registrar resposta de questionário (Público - ASSÍNCRONO)
    /// Retorna 202 Accepted imediatamente e processa em background via fila
    /// </summary>
    [HttpPost]
    [ProducesResponseType(typeof(RespostaRegistradaDto), StatusCodes.Status202Accepted)]
    [ProducesResponseType(typeof(ValidationProblemDetails), StatusCodes.Status400BadRequest)]
    [ProducesResponseType(StatusCodes.Status500InternalServerError)]
    public async Task<ActionResult<RespostaRegistradaDto>> Registrar(
        [FromBody] RegistrarRespostaApiRequest apiRequest,
        CancellationToken cancellationToken)
    {
        // 1️⃣ Validar request da API (FluentValidation)
        var validationResult = await _validator.ValidateAsync(apiRequest, cancellationToken);
        
        if (!validationResult.IsValid)
        {
            return BadRequest(new ValidationProblemDetails
            {
                Title = "Erro de validação",
                Status = StatusCodes.Status400BadRequest,
                Errors = validationResult.Errors
                    .GroupBy(e => e.PropertyName)
                    .ToDictionary(
                        g => g.Key,
                        g => g.Select(e => e.ErrorMessage).ToArray()
                    )
            });
        }

        // 2️⃣ Controller captura dados técnicos (responsabilidade da camada de apresentação)
        var ipAddress = ObterIpAddress();
        var userAgent = ObterUserAgent();
        var (dispositivoTipo, navegadorTipo) = ParsearUserAgent(userAgent);

        // 3️⃣ Mapeia Request da API para DTO da Application
        var applicationRequest = new RegistrarRespostaRequest(
            apiRequest.QuestionarioId,
            apiRequest.Respostas.Select(r => new RespostaItemDto(
                r.PerguntaId,
                r.OpcaoRespostaId
            )).ToList(),
            ipAddress,
            userAgent,
            apiRequest.Estado,
            apiRequest.Cidade,
            apiRequest.RegiaoGeografica,
            dispositivoTipo,
            navegadorTipo
        );

        // 4️⃣ Chama Application Service (retorna Result, não exception)
        var result = await _respostaService.RegistrarRespostaAsync(
            applicationRequest, 
            cancellationToken);

        // 5️⃣ Verifica resultado
        if (result.IsFailure)
        {
            return BadRequest(new ProblemDetails
            {
                Title = "Erro ao registrar resposta",
                Status = StatusCodes.Status400BadRequest,
                Detail = result.Error
            });
        }

        // 6️⃣ Retorna 202 Accepted (processamento assíncrono)
        return AcceptedAtAction(
            nameof(Registrar), 
            new { id = result.Value.Id }, 
            new 
            { 
                mensagem = "Resposta recebida e será processada em breve",
                resposta = result.Value
            });
    }

    #region Métodos Privados (Responsabilidade do Controller)

    private string ObterIpAddress()
    {
        var forwardedFor = HttpContext.Request.Headers["X-Forwarded-For"].FirstOrDefault();
        if (!string.IsNullOrEmpty(forwardedFor))
        {
            var ips = forwardedFor.Split(',');
            return ips[0].Trim();
        }

        var realIp = HttpContext.Request.Headers["X-Real-IP"].FirstOrDefault();
        if (!string.IsNullOrEmpty(realIp))
            return realIp;

        return HttpContext.Connection.RemoteIpAddress?.ToString() ?? "unknown";
    }

    private string ObterUserAgent()
    {
        return HttpContext.Request.Headers["User-Agent"].FirstOrDefault() ?? "unknown";
    }

    private (string? Dispositivo, string? Navegador) ParsearUserAgent(string userAgent)
    {
        try
        {
            var parser = Parser.GetDefault();
            var clientInfo = parser.Parse(userAgent);
            
            return (
                clientInfo.Device.Family,
                $"{clientInfo.UA.Family} {clientInfo.UA.Major}"
            );
        }
        catch
        {
            return (null, null);
        }
    }

    #endregion
}

// DTO público (frontend envia apenas dados essenciais)
public record RegistrarRespostaRequestPublico(
    Guid QuestionarioId,
    List<RespostaItemDto> Respostas,
    string? Estado,
    string? Cidade,
    string? RegiaoGeografica
);
