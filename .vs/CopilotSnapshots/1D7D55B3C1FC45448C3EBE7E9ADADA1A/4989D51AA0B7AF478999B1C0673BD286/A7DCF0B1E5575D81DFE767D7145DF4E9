using QuestionarioOnline.Application.DTOs;
using QuestionarioOnline.Application.Interfaces;
using QuestionarioOnline.Domain.Entities;
using QuestionarioOnline.Domain.Interfaces;
using QuestionarioOnline.Domain.ValueObjects;

namespace QuestionarioOnline.Application.Services;

public class QuestionarioService : IQuestionarioService
{
    private readonly IQuestionarioRepository _questionarioRepository;
    private readonly IRespostaRepository _respostaRepository;

    public QuestionarioService(IQuestionarioRepository questionarioRepository, IRespostaRepository respostaRepository)
    {
        _questionarioRepository = questionarioRepository;
        _respostaRepository = respostaRepository;
    }

    public async Task<QuestionarioDto> CriarQuestionarioAsync(CriarQuestionarioRequest request, Guid usuarioInternoId, CancellationToken cancellationToken = default)
    {
        var periodo = PeriodoColeta.Create(request.DataInicio, request.DataFim);
        var questionario = new Questionario(request.Titulo, request.Descricao, periodo, usuarioInternoId);

        foreach (var perguntaDto in request.Perguntas.OrderBy(p => p.Ordem))
        {
            var pergunta = new Pergunta(questionario.Id, perguntaDto.Texto, perguntaDto.Ordem, perguntaDto.Obrigatoria);

            foreach (var opcaoDto in perguntaDto.Opcoes.OrderBy(o => o.Ordem))
            {
                var opcao = new OpcaoResposta(pergunta.Id, opcaoDto.Texto, opcaoDto.Ordem);
                pergunta.AdicionarOpcao(opcao);
            }

            questionario.AdicionarPergunta(pergunta);
        }

        await _questionarioRepository.AdicionarAsync(questionario, cancellationToken);

        return MapearParaDto(questionario);
    }

    public async Task<QuestionarioDto> PublicarQuestionarioAsync(Guid questionarioId, Guid usuarioInternoId, CancellationToken cancellationToken = default)
    {
        var questionario = await _questionarioRepository.ObterPorIdComPerguntasAsync(questionarioId, cancellationToken);

        if (questionario is null)
            throw new InvalidOperationException("Questionário não encontrado");

        if (questionario.UsuarioInternoId != usuarioInternoId)
            throw new UnauthorizedAccessException("Usuário não autorizado a publicar este questionário");

        questionario.Publicar();

        await _questionarioRepository.AtualizarAsync(questionario, cancellationToken);

        return MapearParaDto(questionario);
    }

    public async Task<QuestionarioDto> EncerrarQuestionarioAsync(Guid questionarioId, Guid usuarioInternoId, CancellationToken cancellationToken = default)
    {
        var questionario = await _questionarioRepository.ObterPorIdComPerguntasAsync(questionarioId, cancellationToken);

        if (questionario is null)
            throw new InvalidOperationException("Questionário não encontrado");

        if (questionario.UsuarioInternoId != usuarioInternoId)
            throw new UnauthorizedAccessException("Usuário não autorizado a encerrar este questionário");

        questionario.Encerrar();

        await _questionarioRepository.AtualizarAsync(questionario, cancellationToken);

        return MapearParaDto(questionario);
    }

    public async Task<QuestionarioPublicoDto?> ObterQuestionarioPublicoAsync(Guid questionarioId, CancellationToken cancellationToken = default)
    {
        var questionario = await _questionarioRepository.ObterPorIdComPerguntasAsync(questionarioId, cancellationToken);

        if (questionario is null || !questionario.PodeReceberRespostas())
            return null;

        return new QuestionarioPublicoDto(
            questionario.Id,
            questionario.Titulo,
            questionario.Descricao,
            questionario.Perguntas.Select(p => new PerguntaDto(
                p.Id,
                p.Texto,
                p.Ordem,
                p.Obrigatoria,
                p.Opcoes.Select(o => new OpcaoDto(o.Id, o.Texto, o.Ordem)).ToList()
            )).ToList()
        );
    }

    public async Task<QuestionarioDto?> ObterQuestionarioPorIdAsync(Guid questionarioId, Guid usuarioInternoId, CancellationToken cancellationToken = default)
    {
        var questionario = await _questionarioRepository.ObterPorIdComPerguntasAsync(questionarioId, cancellationToken);

        if (questionario is null)
            return null;

        if (questionario.UsuarioInternoId != usuarioInternoId)
            throw new UnauthorizedAccessException("Usuário não autorizado a acessar este questionário");

        return MapearParaDto(questionario);
    }

    public async Task<IEnumerable<QuestionarioListaDto>> ListarQuestionariosPorUsuarioAsync(Guid usuarioInternoId, CancellationToken cancellationToken = default)
    {
        var questionarios = await _questionarioRepository.ObterTodosPorUsuarioAsync(usuarioInternoId, cancellationToken);

        return questionarios.Select(q => new QuestionarioListaDto(
            q.Id,
            q.Titulo,
            q.Status.ToString(),
            q.PeriodoColeta.DataInicio,
            q.PeriodoColeta.DataFim,
            q.Perguntas.Count
        ));
    }

    public async Task<ResultadoQuestionarioDto> ObterResultadosAsync(Guid questionarioId, Guid usuarioInternoId, CancellationToken cancellationToken = default)
    {
        var questionario = await _questionarioRepository.ObterPorIdComPerguntasAsync(questionarioId, cancellationToken);

        if (questionario is null)
            throw new InvalidOperationException("Questionário não encontrado");

        if (questionario.UsuarioInternoId != usuarioInternoId)
            throw new UnauthorizedAccessException("Usuário não autorizado a ver resultados deste questionário");

        var respostas = await _respostaRepository.ObterPorQuestionarioAsync(questionarioId, cancellationToken);
        var totalRespostas = respostas.Count();

        var resultadoPerguntas = questionario.Perguntas.Select(pergunta =>
        {
            var resultadoOpcoes = pergunta.Opcoes.Select(opcao =>
            {
                var totalVotos = respostas.SelectMany(r => r.Itens)
                    .Count(item => item.OpcaoRespostaId == opcao.Id);

                var percentual = totalRespostas > 0 ? (double)totalVotos / totalRespostas * 100 : 0;

                return new ResultadoOpcaoDto(opcao.Id, opcao.Texto, totalVotos, percentual);
            }).ToList();

            return new ResultadoPerguntaDto(pergunta.Id, pergunta.Texto, resultadoOpcoes);
        }).ToList();

        return new ResultadoQuestionarioDto(
            questionario.Id,
            questionario.Titulo,
            totalRespostas,
            resultadoPerguntas
        );
    }

    private static QuestionarioDto MapearParaDto(Questionario questionario)
    {
        return new QuestionarioDto(
            questionario.Id,
            questionario.Titulo,
            questionario.Descricao,
            questionario.Status.ToString(),
            questionario.PeriodoColeta.DataInicio,
            questionario.PeriodoColeta.DataFim,
            questionario.DataCriacao,
            questionario.DataPublicacao,
            questionario.DataEncerramento,
            questionario.Perguntas.Select(p => new PerguntaDto(
                p.Id,
                p.Texto,
                p.Ordem,
                p.Obrigatoria,
                p.Opcoes.Select(o => new OpcaoDto(o.Id, o.Texto, o.Ordem)).ToList()
            )).ToList()
        );
    }
}
