# 📋 Sistema de Questionários Online

[![.NET](https://img.shields.io/badge/.NET-8.0-512BD4?style=flat&logo=dotnet)](https://dotnet.microsoft.com/)
[![C#](https://img.shields.io/badge/C%23-12.0-239120?style=flat&logo=c-sharp)](https://docs.microsoft.com/en-us/dotnet/csharp/)
[![Azure](https://img.shields.io/badge/Azure-Queue%20Storage-0089D6?style=flat&logo=microsoft-azure)](https://azure.microsoft.com/)
[![License](https://img.shields.io/badge/license-MIT-green.svg)](LICENSE)

> Sistema empresarial para criação, gerenciamento e coleta de respostas de questionários com processamento assíncrono de alto volume usando Azure Queue Storage.

---

## 📑 **Índice**

- [Sobre o Projeto](#-sobre-o-projeto)
- [Funcionalidades](#-funcionalidades)
- [Arquitetura](#-arquitetura)
- [Tecnologias](#-tecnologias)
- [Estrutura do Projeto](#-estrutura-do-projeto)
- [Diagramas](#-diagramas)
- [Pré-requisitos](#-pré-requisitos)
- [Instalação](#-instalação)
- [Configuração](#-configuração)
- [Como Usar](#-como-usar)
- [API Endpoints](#-api-endpoints)
- [Padrões e Princípios](#-padrões-e-princípios)
- [Performance](#-performance)
- [Documentação Adicional](#-documentação-adicional)
- [Contribuindo](#-contribuindo)
- [Licença](#-licença)

---

## 🎯 **Sobre o Projeto**

O **Sistema de Questionários Online** é uma solução empresarial desenvolvida com **.NET 8** que permite a criação e gerenciamento de questionários por usuários internos (analistas) e a coleta de respostas de usuários externos de forma escalável e assíncrona.

### **Problema Resolvido**

Empresas que precisam coletar grandes volumes de respostas (pesquisas de satisfação, NPS, enquetes) enfrentam desafios de:
- ⚠️ Sobrecarga do servidor durante picos de acesso
- ⚠️ Timeout em requisições com processamento pesado
- ⚠️ Perda de dados em caso de falhas
- ⚠️ Dificuldade em escalar horizontalmente

### **Solução Implementada**

✅ **Processamento Assíncrono**: Respostas são enfileiradas no Azure Queue Storage e processadas por Azure Functions em background, garantindo resposta imediata (202 Accepted) para o usuário.

✅ **Escalabilidade Automática**: Azure Functions escalam automaticamente baseado no volume da fila.

✅ **Resiliência**: Sistema de retry automático e dead letter queue para mensagens com falha.

✅ **Performance**: AsNoTracking no EF Core, índices estratégicos e paginação implementada.

---

## ✨ **Funcionalidades**

### **Usuário Interno (Analista)**
- ✅ Criar questionários com múltiplas perguntas
- ✅ Gerenciar período de coleta (data início/fim)
- ✅ Encerrar questionários
- ✅ Visualizar resultados consolidados
- ✅ Análise demográfica (Estado, Cidade, Região)

### **Usuário Externo (Público)**
- ✅ Responder questionários públicos (sem cadastro)
- ✅ Interface responsiva
- ✅ Validação de completude das respostas

### **Sistema**
- ✅ Autenticação JWT
- ✅ Processamento assíncrono (Azure Queue + Functions)
- ✅ Clean Architecture
- ✅ Domain-Driven Design (DDD)
- ✅ Result Pattern (sem exceptions)
- ✅ Repository Pattern
- ✅ CQRS (Command Query Separation)

---

## 🏗️ **Arquitetura**

### **Clean Architecture + DDD**

O sistema segue os princípios de **Clean Architecture** com separação clara de responsabilidades em **6 camadas**:

```mermaid
graph TB
    subgraph "🔵 PRESENTATION LAYER"
        API[Web API<br/>Controllers, Middleware, JWT]
    end

    subgraph "🟡 APPLICATION LAYER"
        Services[Services<br/>Orquestração e Validação]
    end

    subgraph "🟢 DOMAIN LAYER"
        Entities[Entities<br/>Regras de Negócio]
    end

    subgraph "🟣 INFRASTRUCTURE LAYER"
        Repos[Repositories<br/>EF Core, Azure Queue]
    end

    subgraph "🔴 CROSS-CUTTING LAYER"
        DI[Dependency Injection<br/>Extensions, Constants]
    end

    subgraph "⚫ WORKERS LAYER"
        Functions[Azure Functions<br/>Background Processing]
    end

    API --> Services
    Services --> Entities
    Services --> Repos
    DI -.-> API
    DI -.-> Services
    DI -.-> Repos
    Functions --> Repos

    style Entities fill:#c8e6c9,stroke:#2e7d32,stroke-width:3px
    style Services fill:#fff9c4,stroke:#f57f17,stroke-width:2px
    style API fill:#e1f5ff,stroke:#01579b,stroke-width:2px
    style Repos fill:#d1c4e9,stroke:#4527a0,stroke-width:2px
    style DI fill:#ffccbc,stroke:#d84315,stroke-width:2px
    style Functions fill:#424242,stroke:#212121,stroke-width:2px
```

### **Dependency Rule**

```
Presentation → Application → Domain ← Infrastructure
                             ↑
                    (Dependency Inversion)
```

✅ **Domain** não conhece nada externo (core do negócio)  
✅ **Application** não conhece detalhes de API ou Database  
✅ **Infrastructure** implementa interfaces definidas no Domain  
✅ **CrossCutting** conecta todas as camadas via DI  

---

## 🛠️ **Tecnologias**

### **Backend**
- **.NET 8** - Framework principal
- **ASP.NET Core** - Web API
- **C# 12** - Linguagem

### **Banco de Dados**
- **SQL Server** - Banco relacional
- **Entity Framework Core 8** - ORM
- **FluentAPI** - Configuração de entidades

### **Mensageria**
- **Azure Queue Storage** - Fila de mensagens
- **Azure Functions** - Processamento assíncrono

### **Autenticação**
- **JWT Bearer** - Autenticação stateless
- **BCrypt.Net** - Hash de senhas

### **Validação**
- **FluentValidation** - Validação de DTOs

### **Documentação**
- **Swagger/OpenAPI** - Documentação interativa da API

### **Padrões**
- **Clean Architecture**
- **Domain-Driven Design (DDD)**
- **Repository Pattern**
- **Result Pattern**
- **CQRS**

---

## 📁 **Estrutura do Projeto**

```
QuestionarioOnline/
│
├── 📁 QuestionarioOnline.Api/              # 🔵 PRESENTATION LAYER
│   ├── Controllers/                         # Endpoints REST
│   ├── Services/                            # AuthService (JWT)
│   ├── Responses/                           # ApiResponse<T>
│   ├── Extensions/                          # ClaimsPrincipalExtensions
│   └── Program.cs                           # Startup e Middleware
│
├── 📁 QuestionarioOnline.Application/       # 🟡 APPLICATION LAYER
│   ├── Services/                            # Lógica de aplicação
│   ├── Interfaces/                          # Contratos de serviços
│   ├── DTOs/                                # Request/Response DTOs
│   └── Validators/                          # FluentValidation
│
├── 📁 QuestionarioOnline.Domain/            # 🟢 DOMAIN LAYER
│   ├── Entities/                            # Entidades (Aggregate Roots)
│   │   ├── Questionario.cs ⭐
│   │   ├── Resposta.cs ⭐
│   │   └── UsuarioInterno.cs ⭐
│   ├── ValueObjects/                        # Value Objects
│   │   ├── Email.cs
│   │   ├── PeriodoColeta.cs
│   │   └── OrigemResposta.cs
│   ├── Enums/                               # Enumerações
│   ├── Interfaces/                          # Contratos de repositories
│   └── Constants/                           # Constantes de domínio
│
├── 📁 QuestionarioOnline.Infrastructure/    # 🟣 INFRASTRUCTURE LAYER
│   ├── Persistence/                         # EF Core
│   │   ├── QuestionarioOnlineDbContext.cs
│   │   ├── Configurations/                  # IEntityTypeConfiguration
│   │   └── DbInitializer.cs                 # Seed de dados
│   ├── Repositories/                        # Implementação de repositories
│   └── Messaging/                           # Azure Queue Storage Adapter
│
├── 📁 QuestionarioOnline.CrossCutting/      # 🔴 CROSS-CUTTING LAYER
│   └── DependencyInjection/                 # IoC Container
│
├── 📁 QuestionarioOnline.Workers.Function/  # ⚫ WORKERS LAYER
│   └── ProcessarRespostaFunction.cs         # Azure Function
│
└── 📁 docs/                                  # Documentação
    ├── ARQUITETURA_COMPLETA.md
    ├── EF_CORE_CONFIGURATION.md
    ├── JWT_AUTHENTICATION_GUIDE.md
    └── MELHORIAS_PERFORMANCE.md
```

---

## 📐 **Diagramas**

### **1. Diagrama de Entidades (Domain Model)**

```mermaid
classDiagram
    class Questionario {
        <<Aggregate Root>>
        +Guid Id
        +string Titulo
        +StatusQuestionario Status
        +PeriodoColeta PeriodoColeta
        +IReadOnlyCollection~Pergunta~ Perguntas
        +Criar()$ Questionario
        +AdicionarPergunta(pergunta)
        +Encerrar()
        +PodeReceberRespostas() bool
    }

    class Pergunta {
        +Guid Id
        +string Texto
        +int Ordem
        +bool Obrigatoria
        +IReadOnlyCollection~OpcaoResposta~ Opcoes
    }

    class OpcaoResposta {
        +Guid Id
        +string Texto
        +int Ordem
    }

    class Resposta {
        <<Aggregate Root>>
        +Guid Id
        +Guid QuestionarioId
        +OrigemResposta OrigemResposta
        +DateTime DataResposta
        +IReadOnlyCollection~RespostaItem~ Itens
        +Criar()$ Resposta
        +AdicionarItem(item)
        +ValidarCompletude(perguntas)
    }

    class RespostaItem {
        +Guid Id
        +Guid PerguntaId
        +Guid OpcaoRespostaId
    }

    class UsuarioInterno {
        <<Aggregate Root>>
        +Guid Id
        +string Nome
        +Email Email
        +bool Ativo
        +ValidarSenha(senha) bool
    }

    Questionario "1" *-- "0..*" Pergunta
    Pergunta "1" *-- "2..*" OpcaoResposta
    Resposta "1" *-- "1..*" RespostaItem
    Questionario --> UsuarioInterno
    Resposta --> Questionario
    RespostaItem --> Pergunta
    RespostaItem --> OpcaoResposta

    style Questionario fill:#c8e6c9,stroke:#2e7d32,stroke-width:3px
    style Resposta fill:#c8e6c9,stroke:#2e7d32,stroke-width:3px
    style UsuarioInterno fill:#c8e6c9,stroke:#2e7d32,stroke-width:3px
```

**Aggregate Roots:**
- ⭐ **Questionario**: Gerencia perguntas e opções
- ⭐ **Resposta**: Gerencia itens de resposta
- ⭐ **UsuarioInterno**: Gerencia autenticação e autorização

---

### **2. Fluxo de Comunicação entre Camadas**

```mermaid
sequenceDiagram
    actor User as 👤 Usuário
    participant API as 🔵 API<br/>(Controller)
    participant App as 🟡 Application<br/>(Service)
    participant Domain as 🟢 Domain<br/>(Entity)
    participant Infra as 🟣 Infrastructure<br/>(Repository)
    participant DB as 💾 Database

    User->>API: HTTP Request
    activate API
    
    API->>API: Validar JWT
    API->>App: Chamar Service
    activate App
    
    App->>Domain: Criar/Manipular Entidade
    activate Domain
    Domain->>Domain: Validar Regras de Negócio
    Domain-->>App: Entidade Válida
    deactivate Domain
    
    App->>Infra: Chamar Repository
    activate Infra
    Infra->>DB: SQL Query (EF Core)
    DB-->>Infra: Resultado
    Infra-->>App: Entidade Persistida
    deactivate Infra
    
    App-->>API: Result<T> (Success/Failure)
    deactivate App
    
    API-->>User: HTTP Response (ApiResponse)
    deactivate API
```

**Princípio:** Cada camada só conhece a camada adjacente (Dependency Rule).

---

### **3. Processamento Assíncrono de Respostas**

```mermaid
sequenceDiagram
    participant User as 👤 Usuário
    participant API as Web API
    participant Queue as Azure Queue
    participant Function as Azure Function
    participant DB as SQL Server

    User->>API: POST /api/resposta
    activate API
    
    API->>API: Validar Questionário
    API->>Queue: Enfileirar Mensagem
    activate Queue
    Queue-->>API: Enfileirado
    deactivate Queue
    
    API-->>User: 202 Accepted<br/>(Processando...)
    deactivate API
    
    Note over Queue,Function: Processamento<br/>Assíncrono
    
    Queue->>Function: Trigger
    activate Function
    
    Function->>Function: Processar Mensagem
    Function->>DB: Persistir Resposta
    DB-->>Function: Sucesso
    
    Function-->>Queue: Completar Mensagem
    deactivate Function
```

**Benefícios:**
- ⚡ Resposta imediata para o usuário (202 Accepted)
- 🚀 Escalabilidade automática (Azure Functions)
- 🔄 Retry automático em caso de falha
- 📮 Dead letter queue para mensagens problemáticas

---

### **4. Arquitetura C4 - Container**

```mermaid
C4Container
    title Sistema de Questionários Online - Container

    Person(user_interno, "Usuário Interno")
    Person(user_externo, "Usuário Externo")

    Container_Boundary(system, "Sistema") {
        Container(api, "Web API", ".NET 8")
        Container(function, "Azure Function", ".NET 8")
        ContainerDb(db, "Database", "SQL Server")
        ContainerQueue(queue, "Queue", "Azure Storage")
    }

    Rel(user_interno, api, "Gerencia", "HTTPS/JWT")
    Rel(user_externo, api, "Responde", "HTTPS")
    Rel(api, queue, "Enfileira")
    Rel(api, db, "Lê/Escreve")
    Rel(function, queue, "Consome")
    Rel(function, db, "Escreve")
```

---

## 📋 **Pré-requisitos**

- ✅ [.NET 8 SDK](https://dotnet.microsoft.com/download/dotnet/8.0)
- ✅ [SQL Server](https://www.microsoft.com/sql-server) ou SQL Server LocalDB
- ✅ [Azure Storage Emulator](https://learn.microsoft.com/azure/storage/common/storage-use-emulator) (para desenvolvimento local)
- ✅ [Visual Studio 2022](https://visualstudio.microsoft.com/) ou [VS Code](https://code.visualstudio.com/)

---

## 🚀 **Instalação**

### **1. Clone o repositório**

```bash
git clone https://github.com/seu-usuario/questionario-online.git
cd questionario-online
```

### **2. Restore pacotes NuGet**

```bash
dotnet restore
```

### **3. Configure a connection string**

Edite `QuestionarioOnline/appsettings.json`:

```json
{
  "ConnectionStrings": {
    "DefaultConnection": "Server=(localdb)\\mssqllocaldb;Database=QuestionarioOnlineDb;Trusted_Connection=True",
    "AzureWebJobsStorage": "UseDevelopmentStorage=true"
  }
}
```

### **4. Execute as migrations (cria o banco)**

```bash
dotnet run --project QuestionarioOnline
```

O banco será criado automaticamente via `EnsureCreatedAsync()` no primeiro run.

### **5. (Opcional) Inicie o Azure Storage Emulator**

```bash
# Windows
AzureStorageEmulator.exe start

# Linux/Mac (use Azurite)
azurite --silent
```

---

## ⚙️ **Configuração**

### **JWT Settings**

Configure as credenciais JWT em `appsettings.json`:

```json
{
  "JwtSettings": {
    "SecretKey": "SuaChaveSecretaSuperSegura256Bits!",
    "Issuer": "QuestionarioOnline",
    "Audience": "QuestionarioOnlineAPI",
    "ExpirationMinutes": 60
  }
}
```

⚠️ **Produção:** Use Azure Key Vault ou variáveis de ambiente.

### **Azure Queue Storage**

```json
{
  "ConnectionStrings": {
    "AzureWebJobsStorage": "DefaultEndpointsProtocol=https;AccountName=...;AccountKey=...;"
  }
}
```

---

## 💻 **Como Usar**

### **1. Inicie a API**

```bash
dotnet run --project QuestionarioOnline
```

Acesse: `https://localhost:7xxx/swagger`

### **2. Login (Mock para desenvolvimento)**

```http
POST /api/auth/login
Content-Type: application/json

{
  "email": "analista@empresa.com",
  "senha": "Senha123"
}
```

**Response:**
```json
{
  "success": true,
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "usuarioId": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
    "nome": "Analista Teste",
    "email": "analista@empresa.com"
  }
}
```

### **3. Criar Questionário**

```http
POST /api/questionario
Authorization: Bearer {token}
Content-Type: application/json

{
  "titulo": "Pesquisa de Satisfação 2024",
  "descricao": "Avalie nossos serviços",
  "dataInicio": "2024-01-01T00:00:00Z",
  "dataFim": "2024-12-31T23:59:59Z",
  "perguntas": [
    {
      "texto": "Como você avalia nosso atendimento?",
      "ordem": 1,
      "obrigatoria": true,
      "opcoes": [
        { "texto": "Excelente", "ordem": 1 },
        { "texto": "Bom", "ordem": 2 },
        { "texto": "Regular", "ordem": 3 },
        { "texto": "Ruim", "ordem": 4 }
      ]
    }
  ]
}
```

### **4. Responder Questionário (público)**

```http
POST /api/resposta
Content-Type: application/json

{
  "questionarioId": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
  "respostas": [
    {
      "perguntaId": "8f7a1234-5678-9abc-def0-123456789abc",
      "opcaoRespostaId": "1a2b3c4d-5e6f-7a8b-9c0d-1e2f3a4b5c6d"
    }
  ],
  "estado": "SP",
  "cidade": "São Paulo"
}
```

**Response (Assíncrono):**
```json
{
  "success": true,
  "data": {
    "id": "9d8e7f6g-5h4i-3j2k-1l0m-9n8o7p6q5r4s",
    "questionarioId": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
    "dataResposta": "2024-01-15T10:30:00Z"
  },
  "message": "Resposta recebida e será processada em breve"
}
```

⚡ Status: **202 Accepted** (processamento assíncrono em background)

---

## 📡 **API Endpoints**

### **Autenticação**
| Método | Endpoint | Descrição | Auth |
|--------|----------|-----------|------|
| `POST` | `/api/auth/login` | Login (mock) | ❌ |

### **Questionários**
| Método | Endpoint | Descrição | Auth |
|--------|----------|-----------|------|
| `POST` | `/api/questionario` | Criar questionário | ✅ JWT |
| `GET` | `/api/questionario` | Listar questionários do usuário | ✅ JWT |
| `GET` | `/api/questionario/{id}` | Obter por ID | ✅ JWT |
| `GET` | `/api/questionario/publico/{id}` | Obter público (responder) | ❌ |
| `POST` | `/api/questionario/{id}/encerrar` | Encerrar questionário | ✅ JWT |
| `GET` | `/api/questionario/{id}/resultados` | Obter resultados | ✅ JWT |

### **Respostas**
| Método | Endpoint | Descrição | Auth |
|--------|----------|-----------|------|
| `POST` | `/api/resposta` | Registrar resposta (assíncrono) | ❌ |

📖 **Documentação completa:** `/swagger`

---

## 🎯 **Padrões e Princípios**

### **Clean Architecture**
✅ Dependency Rule (camadas externas → internas)  
✅ Domain não conhece Infrastructure  
✅ Interfaces no Domain, implementação na Infrastructure  

### **DDD (Domain-Driven Design)**
✅ Aggregate Roots (Questionario, Resposta, UsuarioInterno)  
✅ Value Objects (Email, PeriodoColeta, OrigemResposta)  
✅ Rich Domain Model (comportamento nas entidades)  
✅ Factory Methods (Questionario.Criar(), Email.Create())  

### **SOLID**
✅ **SRP**: Cada classe tem responsabilidade única  
✅ **OCP**: Extensível via interfaces  
✅ **LSP**: Substituição de implementações  
✅ **ISP**: Interfaces segregadas  
✅ **DIP**: Depende de abstrações (interfaces)  

### **Repository Pattern**
✅ Interface no Domain, implementação na Infrastructure  
✅ AsNoTracking em queries de leitura  
✅ Paginação implementada  

### **Result Pattern**
✅ Sem exceptions em fluxo normal  
✅ `Result<T>` com Success/Failure  
✅ Error messages claros  

### **CQRS (Command Query Separation)**
✅ Commands: CriarQuestionario, RegistrarResposta  
✅ Queries: ObterQuestionarioPorId, ListarQuestionarios  
✅ Read models separados (DTOs)  

---

## ⚡ **Performance**

### **Otimizações Implementadas**

| Otimização | Impacto | Descrição |
|------------|---------|-----------|
| **AsNoTracking** | +30% | Queries de leitura sem Change Tracker |
| **Índices Estratégicos** | +40x | 14 índices em campos de busca/filtro |
| **Paginação** | +100x | Skip/Take em listagens |
| **Processamento Assíncrono** | ∞ | Azure Queue + Functions escaláveis |
| **Owned Types** | +20% | ValueObjects sem tabelas extras |

### **Métricas**

```
Query ObterPorId: 35ms (antes: 50ms)
Listagem 100 registros: 50ms (antes: 500ms)
Busca por Estado: 50ms (antes: 2000ms)
Registrar resposta: <5ms (202 Accepted)
Processar 10k respostas: ~2min (paralelo)
```

📊 Veja análise completa em: [MELHORIAS_PERFORMANCE.md](docs/MELHORIAS_PERFORMANCE.md)

---

## 📚 **Documentação Adicional**

| Documento | Descrição |
|-----------|-----------|
| [ARQUITETURA_COMPLETA.md](docs/ARQUITETURA_COMPLETA.md) | Diagramas C4, UML, Sequence Diagrams |
| [EF_CORE_CONFIGURATION.md](docs/EF_CORE_CONFIGURATION.md) | Configuração do Entity Framework |
| [JWT_AUTHENTICATION_GUIDE.md](docs/JWT_AUTHENTICATION_GUIDE.md) | Autenticação e Autorização |
| [MELHORIAS_PERFORMANCE.md](docs/MELHORIAS_PERFORMANCE.md) | Otimizações aplicadas |
| [CODIGO_SIMPLIFICADO.md](docs/CODIGO_SIMPLIFICADO.md) | Boas práticas de código |
| [ANALISE_PERSISTENCIA.md](docs/ANALISE_PERSISTENCIA.md) | Análise de performance do EF |

---

## 🤝 **Contribuindo**

Contribuições são bem-vindas! Siga os passos:

1. Fork o projeto
2. Crie uma branch para sua feature (`git checkout -b feature/MinhaFeature`)
3. Commit suas mudanças (`git commit -m 'Adiciona MinhaFeature'`)
4. Push para a branch (`git push origin feature/MinhaFeature`)
5. Abra um Pull Request

### **Padrões de Commit**

```
feat: Nova funcionalidade
fix: Correção de bug
docs: Documentação
refactor: Refatoração de código
test: Testes
perf: Performance
```

---

## 📄 **Licença**

Este projeto está sob a licença MIT. Veja o arquivo [LICENSE](LICENSE) para mais detalhes.

---

## 👥 **Autores**

**Seu Nome** - [GitHub](https://github.com/seu-usuario) - [LinkedIn](https://linkedin.com/in/seu-perfil)

---

## 🙏 **Agradecimentos**

- Microsoft por .NET e Azure
- Comunidade open-source
- Contribuidores do projeto

---

## 📞 **Contato**

📧 Email: seuemail@exemplo.com  
💼 LinkedIn: [seu-perfil](https://linkedin.com/in/seu-perfil)  
🐦 Twitter: [@seu-usuario](https://twitter.com/seu-usuario)

---

<div align="center">

**⭐ Se este projeto foi útil, considere dar uma estrela! ⭐**

[![GitHub stars](https://img.shields.io/github/stars/seu-usuario/questionario-online?style=social)](https://github.com/seu-usuario/questionario-online/stargazers)
[![GitHub forks](https://img.shields.io/github/forks/seu-usuario/questionario-online?style=social)](https://github.com/seu-usuario/questionario-online/network/members)

</div>

---

**Desenvolvido com ❤️ usando .NET 8 e Clean Architecture**
