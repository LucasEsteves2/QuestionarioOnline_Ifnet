using FluentValidation;
using Microsoft.AspNetCore.Mvc;
using QuestionarioOnline.Application.DTOs;
using QuestionarioOnline.Application.Interfaces;

namespace QuestionarioOnline.Api.Controllers;

[ApiController]
[Route("api/[controller]")]
public class QuestionarioController : ControllerBase
{
    private readonly IQuestionarioService _questionarioService;
    private readonly IValidator<CriarQuestionarioRequest> _criarValidator;

    public QuestionarioController(
        IQuestionarioService questionarioService,
        IValidator<CriarQuestionarioRequest> criarValidator)
    {
        _questionarioService = questionarioService;
        _criarValidator = criarValidator;
    }

    /// <summary>
    /// Criar um novo questionário (Usuário Interno Autenticado)
    /// ✅ Valida entrada com FluentValidation ANTES de chamar Domain
    /// </summary>
    [HttpPost]
    [ProducesResponseType(typeof(QuestionarioDto), StatusCodes.Status201Created)]
    [ProducesResponseType(typeof(ValidationProblemDetails), StatusCodes.Status400BadRequest)]
    public async Task<ActionResult<QuestionarioDto>> Criar(
        [FromBody] CriarQuestionarioRequest request,
        CancellationToken cancellationToken)
    {
        // ✅ 1. VALIDAR ENTRADA (FluentValidation)
        var validationResult = await _criarValidator.ValidateAsync(request, cancellationToken);

        if (!validationResult.IsValid)
        {
            return BadRequest(new ValidationProblemDetails
            {
                Title = "Erro de validação",
                Status = StatusCodes.Status400BadRequest,
                Errors = validationResult.Errors
                    .GroupBy(e => e.PropertyName)
                    .ToDictionary(
                        g => g.Key,
                        g => g.Select(e => e.ErrorMessage).ToArray()
                    )
            });
        }

        // TODO: Extrair usuário do token JWT
        var usuarioId = ObterUsuarioIdDoToken();

        // ✅ 2. CHAMAR SERVICE (que chama Domain)
        var result = await _questionarioService.CriarQuestionarioAsync(
            request,
            usuarioId,
            cancellationToken);

        // ✅ 3. TRATAR RESULTADO (Result Pattern)
        if (result.IsFailure)
        {
            return BadRequest(new ProblemDetails
            {
                Title = "Erro ao criar questionário",
                Detail = result.Error
            });
        }

        return CreatedAtAction(
            nameof(ObterPorId),
            new { id = result.Value.Id },
            result.Value);
    }

    /// <summary>
    /// Publicar um questionário (Usuário Interno Autenticado)
    /// </summary>
    [HttpPost("{id}/publicar")]
    [ProducesResponseType(typeof(QuestionarioDto), StatusCodes.Status200OK)]
    [ProducesResponseType(typeof(ProblemDetails), StatusCodes.Status400BadRequest)]
    public async Task<ActionResult<QuestionarioDto>> Publicar(
        Guid id,
        CancellationToken cancellationToken)
    {
        var usuarioId = ObterUsuarioIdDoToken();

        var result = await _questionarioService.PublicarQuestionarioAsync(id, usuarioId, cancellationToken);

        if (result.IsFailure)
        {
            return BadRequest(new ProblemDetails
            {
                Title = "Erro ao publicar questionário",
                Detail = result.Error
            });
        }

        return Ok(result.Value);
    }

    /// <summary>
    /// Encerrar um questionário (Usuário Interno Autenticado)
    /// </summary>
    [HttpPost("{id}/encerrar")]
    [ProducesResponseType(typeof(QuestionarioDto), StatusCodes.Status200OK)]
    [ProducesResponseType(typeof(ProblemDetails), StatusCodes.Status400BadRequest)]
    public async Task<ActionResult<QuestionarioDto>> Encerrar(
        Guid id,
        CancellationToken cancellationToken)
    {
        var usuarioId = ObterUsuarioIdDoToken();

        var result = await _questionarioService.EncerrarQuestionarioAsync(id, usuarioId, cancellationToken);

        if (result.IsFailure)
        {
            return BadRequest(new ProblemDetails
            {
                Title = "Erro ao encerrar questionário",
                Detail = result.Error
            });
        }

        return Ok(result.Value);
    }

    /// <summary>
    /// Obter questionário público (Acesso Público - para responder)
    /// </summary>
    [HttpGet("publico/{id}")]
    [ProducesResponseType(typeof(QuestionarioPublicoDto), StatusCodes.Status200OK)]
    [ProducesResponseType(StatusCodes.Status404NotFound)]
    public async Task<ActionResult<QuestionarioPublicoDto>> ObterPublico(
        Guid id,
        CancellationToken cancellationToken)
    {
        var questionario = await _questionarioService.ObterQuestionarioPublicoAsync(id, cancellationToken);

        if (questionario is null)
            return NotFound();

        return Ok(questionario);
    }

    /// <summary>
    /// Obter questionário por ID (Usuário Interno Autenticado)
    /// </summary>
    [HttpGet("{id}")]
    [ProducesResponseType(typeof(QuestionarioDto), StatusCodes.Status200OK)]
    [ProducesResponseType(StatusCodes.Status404NotFound)]
    public async Task<ActionResult<QuestionarioDto>> ObterPorId(
        Guid id,
        CancellationToken cancellationToken)
    {
        var usuarioId = ObterUsuarioIdDoToken();

        var questionario = await _questionarioService.ObterQuestionarioPorIdAsync(id, usuarioId, cancellationToken);

        if (questionario is null)
            return NotFound();

        return Ok(questionario);
    }

    /// <summary>
    /// Listar questionários do usuário autenticado
    /// </summary>
    [HttpGet]
    [ProducesResponseType(typeof(IEnumerable<QuestionarioListaDto>), StatusCodes.Status200OK)]
    public async Task<ActionResult<IEnumerable<QuestionarioListaDto>>> Listar(
        CancellationToken cancellationToken)
    {
        var usuarioId = ObterUsuarioIdDoToken();

        var questionarios = await _questionarioService.ListarQuestionariosPorUsuarioAsync(usuarioId, cancellationToken);

        return Ok(questionarios);
    }

    /// <summary>
    /// Obter resultados de um questionário (Usuário Interno Autenticado)
    /// </summary>
    [HttpGet("{id}/resultados")]
    [ProducesResponseType(typeof(ResultadoQuestionarioDto), StatusCodes.Status200OK)]
    [ProducesResponseType(StatusCodes.Status404NotFound)]
    public async Task<ActionResult<ResultadoQuestionarioDto>> ObterResultados(
        Guid id,
        CancellationToken cancellationToken)
    {
        try
        {
            var usuarioId = ObterUsuarioIdDoToken();

            var resultado = await _questionarioService.ObterResultadosAsync(id, usuarioId, cancellationToken);

            return Ok(resultado);
        }
        catch (InvalidOperationException ex)
        {
            return NotFound(new { mensagem = ex.Message });
        }
        catch (UnauthorizedAccessException ex)
        {
            return Unauthorized(new { mensagem = ex.Message });
        }
    }

    private Guid ObterUsuarioIdDoToken()
    {
        // TODO: Implementar extração do usuário do token JWT
        // Por enquanto, retorna um GUID fixo para desenvolvimento
        return Guid.Parse("00000000-0000-0000-0000-000000000001");
    }
}
